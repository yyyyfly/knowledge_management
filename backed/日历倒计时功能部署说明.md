# 日历倒计时功能部署说明

## 功能概述
为日历事件添加"倒计时"功能，用户可以选择是否为某个事件启用倒计时。启用后，系统可以在其他地方（如首页）显示距离该事件的天数。

## 三个主要问题修复

### 1. 节假日显示问题
**问题**: 节假日加载成功但界面上不显示（如国庆节）
**修复**:
- 添加调试日志到 `loadHolidays()` 和 `getHolidayForDate()` 函数
- 在控制台查看节假日数据格式和匹配情况
- 确保日期格式一致（`YYYY-MM-DD`）

**调试方法**:
1. 打开浏览器开发者工具（F12）→ Console
2. 查看以下日志：
   - `节假日加载成功: X 个节假日`
   - `节假日示例: [...]`
   - `找到节假日: YYYY-MM-DD - 节日名称`

### 2. 日期输入框默认值
**问题**: 打开"添加日期"模态框时，日期输入框显示 placeholder 而不是当前日期
**修复**:
- 创建 `openCreateEventModal()` 函数
- 自动设置 `eventForm.eventDate` 为当前日期
- 修改"添加日期"按钮调用此函数

**代码变更**:
```javascript
// 打开创建事件模态框（设置默认日期为当前日期）
const openCreateEventModal = () => {
  const today = new Date()
  eventForm.eventDate = formatDateToString(today)
  showCreateEvent.value = true
}
```

### 3. 倒计时功能
**功能**: 为事件添加"是否显示倒计时"开关
**实现**:
- 前端：倒计时开关（Toggle Switch）
- 后端：新增 `show_countdown` 字段
- 用途：标记哪些事件需要在其他地方显示倒计时

## 数据库变更

### 新增字段
在 `km_calendar_event` 表中添加：
```sql
`show_countdown` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否显示倒计时:0-否,1-是'
```

### 迁移 SQL（如果表已存在）
```sql
-- 添加倒计时字段
ALTER TABLE `km_calendar_event` 
ADD COLUMN `show_countdown` TINYINT(1) NOT NULL DEFAULT 0 
COMMENT '是否显示倒计时:0-否,1-是' 
AFTER `color`;

-- 添加索引
ALTER TABLE `km_calendar_event` 
ADD KEY `idx_show_countdown` (`show_countdown`);
```

## 后端变更

### 1. 实体类（CalendarEvent.java）
```java
/**
 * 是否显示倒计时
 */
private Boolean showCountdown;
```

### 2. Mapper XML（CalendarEventMapper.xml）
- ResultMap 中添加 `show_countdown` 映射
- INSERT 语句中添加 `show_countdown` 字段
- UPDATE 语句中添加 `show_countdown` 字段

## 前端变更

### 1. 表单数据（eventForm）
```javascript
const eventForm = reactive({
  eventTitle: '',
  eventDate: '',
  repeatType: 'once',
  description: '',
  color: '#3b82f6',
  showCountdown: false // 新增
})
```

### 2. UI 组件
在"重复类型"和"事件描述"之间添加倒计时开关：
```html
<!-- 倒计时功能 -->
<div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
  <div class="flex items-center space-x-2">
    <i class="fas fa-hourglass-half text-emerald-600"></i>
    <div>
      <label class="text-sm font-medium text-gray-700">启用倒计时</label>
      <p class="text-xs text-gray-500">在其他地方显示距离此日期的天数</p>
    </div>
  </div>
  <label class="relative inline-flex items-center cursor-pointer">
    <input type="checkbox" v-model="eventForm.showCountdown" class="sr-only peer">
    <div class="w-11 h-6 bg-gray-200 ... peer-checked:bg-emerald-600"></div>
  </label>
</div>
```

### 3. 函数更新
- `openCreateEventModal()`: 新增，设置默认日期
- `closeEventModal()`: 重置 `showCountdown`
- `editEvent()`: 读取 `showCountdown`

## 部署步骤

### 1. 数据库更新
如果表已存在，执行迁移 SQL：
```bash
# 连接到数据库
mysql -u root -p knowledge_management

# 执行 ALTER TABLE 语句（见上方）
```

### 2. 后端部署
```bash
cd backed

# 重新编译
mvn clean package -DskipTests

# 重启服务
# （根据你的部署方式重启 Spring Boot 应用）
```

### 3. 前端部署
```bash
cd fronted

# 重新构建（如果是生产环境）
npm run build

# 或开发环境直接刷新浏览器
```

## 使用说明

### 创建带倒计时的事件
1. 点击"添加日期"按钮
2. 填写事件标题、日期等信息
3. 开启"启用倒计时"开关
4. 点击"添加日期"保存

### 查看倒计时
倒计时功能将在后续版本中实现在：
- 数据概览页面
- 侧边栏快捷信息
- 首页仪表板

## 节假日调试指南

### 如果节假日不显示
1. **检查 API 响应**:
   - 控制台应显示：`节假日加载成功: 33 个节假日`
   - 查看示例数据格式

2. **检查日期格式**:
   - 节假日 API 返回格式：`YYYY-MM-DD`（如 `2025-10-01`）
   - 日历格子日期格式：通过 `formatDateToString()` 生成
   - 确保两者完全一致

3. **检查匹配逻辑**:
   - 查看控制台是否有"找到节假日"的日志
   - 如果没有，说明日期不匹配

4. **备用方案**:
   如果 API 无法访问，可以使用本地节假日数据

## 注意事项

1. **数据类型**: `showCountdown` 在数据库中是 `TINYINT(1)`，在 Java 中是 `Boolean`
2. **默认值**: 新建事件时 `showCountdown` 默认为 `false`（0）
3. **兼容性**: 旧数据自动设置为不显示倒计时
4. **日期格式**: 统一使用 `yyyy-MM-dd` 格式

## 测试清单

- [ ] 创建新事件，开启倒计时
- [ ] 创建新事件，不开启倒计时
- [ ] 编辑已有事件，修改倒计时状态
- [ ] 删除事件
- [ ] 查看事件列表，确认倒计时状态正确显示
- [ ] 节假日显示正常（如国庆节、春节等）
- [ ] 打开"添加日期"模态框，日期默认为当前日期
- [ ] 点击日历格子，日期自动填充
- [ ] 即将到来的节假日列表显示正常

## 后续开发建议

1. **倒计时显示组件**: 创建一个专门的组件显示所有启用倒计时的事件
2. **倒计时提醒**: 距离事件X天时发送提醒
3. **倒计时样式**: 根据剩余天数改变颜色（绿色→黄色→红色）
4. **倒计时排序**: 在显示区域按剩余天数排序

