# 时光轨迹功能完整修复步骤

## 🐛 **当前问题**

错误信息显示：
1. ❌ 表不存在：`Table 'knowledge_management.km_timeline_event' doesn't exist`
2. ❌ 后端运行旧代码：错误显示 `arch_flag = '1'`（字符串），但代码已改为 `arch_flag = 1`

## ✅ **完整修复步骤**

### 第一步：检查数据库表是否存在

**执行检查SQL**：
```bash
mysql -u root -p knowledge_management < backed/检查表是否存在.sql
```

或在MySQL客户端执行：
```sql
USE knowledge_management;
SHOW TABLES LIKE 'km_%';
```

### 第二步：创建数据库表（如果不存在）

**方法1：使用命令行（推荐）**
```bash
mysql -u root -p knowledge_management < backed/创建时光轨迹表.sql
```

**方法2：使用MySQL客户端**
1. 打开 `backed/创建时光轨迹表.sql`
2. 全选内容并执行（F9 或点击运行）

**方法3：直接复制执行**
```sql
USE knowledge_management;

-- 删除旧表
DROP TABLE IF EXISTS `km_timeline_event`;
DROP TABLE IF EXISTS `km_topic`;

-- 创建主题表
CREATE TABLE `km_topic` (
  `id` VARCHAR(50) NOT NULL COMMENT '主题ID',
  `name` VARCHAR(100) NOT NULL COMMENT '主题名称',
  `rec_creator` VARCHAR(64) NOT NULL DEFAULT 'system' COMMENT '创建人',
  `rec_create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `rec_revisor` VARCHAR(64) NOT NULL DEFAULT 'system' COMMENT '修改人',
  `rec_revise_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  `arch_flag` INT(1) NOT NULL DEFAULT 1 COMMENT '归档标志:0-已删除,1-正常',
  PRIMARY KEY (`id`),
  KEY `idx_arch_flag` (`arch_flag`),
  KEY `idx_create_time` (`rec_create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='时间轴主题表';

-- 创建时光轨迹事件表
CREATE TABLE `km_timeline_event` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `event_type` VARCHAR(20) NOT NULL COMMENT '事件类型：global-全局历史事件, milestone-专项时间轴里程碑',
  `title` VARCHAR(200) NOT NULL COMMENT '事件标题',
  `description` TEXT COMMENT '事件描述',
  `event_date` DATE NOT NULL COMMENT '事件日期',
  `topic_id` VARCHAR(50) COMMENT '主题ID（关联km_topic表）',
  `rec_creator` VARCHAR(64) NOT NULL DEFAULT 'system' COMMENT '创建人',
  `rec_create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `rec_revisor` VARCHAR(64) NOT NULL DEFAULT 'system' COMMENT '修订人',
  `rec_revise_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修订时间',
  `arch_flag` INT(1) NOT NULL DEFAULT 1 COMMENT '归档标志:0-已删除,1-正常',
  PRIMARY KEY (`id`),
  KEY `idx_event_type` (`event_type`),
  KEY `idx_event_date` (`event_date`),
  KEY `idx_topic_id` (`topic_id`),
  CONSTRAINT `fk_timeline_topic` FOREIGN KEY (`topic_id`) REFERENCES `km_topic` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='时光轨迹事件表';
```

### 第三步：重新编译后端（重要！）

**进入后端目录**：
```bash
cd backed
```

**方法1：Maven编译（推荐）**
```bash
mvn clean package -DskipTests
```

**方法2：如果用的是IDE**
- IntelliJ IDEA：点击 `Build` → `Rebuild Project`
- Eclipse：点击 `Project` → `Clean...` → `Build`

### 第四步：重启后端服务

**停止当前运行的后端服务**，然后重新启动：

**方法1：如果用的是jar包**
```bash
# 停止旧进程
# Windows: 在任务管理器中结束 java.exe 进程
# Linux/Mac: kill -9 <进程ID>

# 启动新编译的jar
java -jar target/knowledge-management-1.0.0.jar
```

**方法2：如果用的是IDE**
- 停止运行中的Spring Boot应用
- 重新点击 Run 按钮启动

### 第五步：清理浏览器缓存并刷新

1. **清理浏览器缓存**：
   - Chrome/Edge：按 `Ctrl + Shift + Delete`
   - 或直接强制刷新：`Ctrl + F5`

2. **刷新前端页面**：
   - 访问：`http://localhost:5173/overview/timeline`
   - 按 `F5` 刷新

## 🔍 **验证修复是否成功**

### 1. 数据库验证
```sql
-- 查看表是否创建成功
SHOW TABLES LIKE 'km_%';

-- 查看表结构
DESC km_timeline_event;

-- 应该看到 arch_flag 是 INT(1) 类型，默认值是 1（不是 '1'）
```

### 2. 后端日志验证
启动后端后，查看控制台日志，应该看到：
```
Mapped "{[/timeline/global],methods=[GET]}" onto ...
Mapped "{[/timeline/milestones],methods=[GET]}" onto ...
```

### 3. 前端功能验证
1. 打开浏览器开发者工具（F12）
2. 访问时光轨迹页面
3. 查看 Network 标签
4. 应该看到 API 请求成功（状态码 200）
5. 不再有表不存在的错误

## 🚨 **如果还有问题**

### 问题1：编译失败
```bash
# 清理Maven缓存
mvn clean

# 强制更新依赖
mvn clean install -U
```

### 问题2：端口被占用
```bash
# Windows - 查找占用8080端口的进程
netstat -ano | findstr :8080

# 结束进程
taskkill /PID <进程ID> /F
```

### 问题3：MySQL连接失败
检查 `application.yml` 或 `application.properties`：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/knowledge_management
    username: root
    password: <你的密码>
```

### 问题4：表创建失败（外键错误）
按顺序执行：
```sql
-- 1. 先删除有外键的表
DROP TABLE IF EXISTS km_timeline_event;

-- 2. 再删除被引用的表
DROP TABLE IF EXISTS km_topic;

-- 3. 先创建被引用的表
CREATE TABLE km_topic (...);

-- 4. 再创建有外键的表
CREATE TABLE km_timeline_event (...);
```

## 📋 **检查清单**

完成后，逐项确认：

- [ ] 数据库中 `km_topic` 表已创建
- [ ] 数据库中 `km_timeline_event` 表已创建
- [ ] `arch_flag` 字段类型是 `INT(1)`，默认值是 `1`（不是 `'1'`）
- [ ] 后端代码已重新编译（执行了 `mvn clean package`）
- [ ] 后端服务已重启
- [ ] 浏览器缓存已清理
- [ ] 前端页面访问正常，无报错
- [ ] 可以添加历史事件和里程碑

## 🎯 **预期结果**

修复成功后：
1. ✅ 时光轨迹页面正常显示
2. ✅ 可以添加全局历史事件
3. ✅ 可以创建主题并添加里程碑
4. ✅ 可以编辑/删除主题
5. ✅ 数据持久化到MySQL数据库

---

**最后提醒**：修改Mapper XML后，**必须重新编译并重启后端**，否则运行的还是旧代码！

