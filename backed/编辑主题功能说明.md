# 编辑主题功能实现说明

## 📋 功能概述

在日常总结页面的"专项时间轴"功能中，新增了编辑主题名称的功能，用户可以方便地修改已创建主题的名称。

## 🎨 前端实现

### UI设计（方案1）

在主题选择区域增加了编辑按钮：

```
[选择已有主题 ▼] [✏️ 编辑] [🗑️ 删除] [➕ 新建主题]
```

### 操作流程

1. **选择主题** - 从下拉框中选择需要编辑的主题
2. **点击编辑** - 点击蓝色"✏️"编辑按钮
3. **修改名称** - 在弹出的输入框中修改主题名称
4. **保存更新** - 点击"保存"按钮或按回车键确认
5. **取消编辑** - 点击"取消"按钮放弃修改

### 前端代码位置

**文件**：`fronted/src/views/daily/DailySummary.vue`

#### 新增状态变量
```typescript
const isEditingTopic = ref(false)      // 是否正在编辑主题
const editTopicName = ref('')          // 编辑中的主题名称
const editingTopicId = ref('')         // 正在编辑的主题ID
```

#### 核心函数

**显示编辑框**
```typescript
const showEditTopicInput = () => {
  if (!milestoneForm.value.topicId) return
  
  showNewTopicInput.value = false  // 关闭新建主题输入框
  
  const selectedTopic = availableTopics.value.find(t => t.id === milestoneForm.value.topicId)
  if (selectedTopic) {
    editingTopicId.value = selectedTopic.id
    editTopicName.value = selectedTopic.name
    isEditingTopic.value = true
  }
}
```

**确认编辑**
```typescript
const confirmEditTopic = async () => {
  if (!editTopicName.value.trim()) {
    alert('请输入主题名称')
    return
  }
  
  const newName = editTopicName.value.trim()
  
  // 调用API更新
  const response = await request.put(`/timeline/topic/${editingTopicId.value}`, {
    name: newName
  })
  
  if (response.code === 200) {
    // 更新本地列表
    const topicIndex = availableTopics.value.findIndex(t => t.id === editingTopicId.value)
    if (topicIndex !== -1) {
      availableTopics.value[topicIndex].name = newName
    }
    
    alert('✅ 主题名称已更新')
    cancelEditTopic()
    
    // 重新加载主题列表
    await loadAvailableTopics()
  }
}
```

**取消编辑**
```typescript
const cancelEditTopic = () => {
  isEditingTopic.value = false
  editTopicName.value = ''
  editingTopicId.value = ''
}
```

## 🔧 后端实现

### API接口

#### 更新主题名称
- **请求方式**：`PUT`
- **接口路径**：`/timeline/topic/{topicId}`
- **请求参数**：
  ```json
  {
    "name": "新的主题名称"
  }
  ```
- **返回数据**：
  ```json
  {
    "code": 200,
    "message": "更新成功",
    "data": {
      "id": "user-topic-123456",
      "name": "新的主题名称"
    }
  }
  ```

### 后端代码位置

#### Controller层
**文件**：`backed/src/main/java/com/knowledge/controller/TimelineEventController.java`

```java
@PutMapping("/topic/{topicId}")
public Map<String, Object> updateTopic(
    @PathVariable String topicId, 
    @RequestBody Map<String, Object> params
) {
    Map<String, Object> response = new HashMap<>();
    try {
        // 检查主题是否存在
        Topic existingTopic = topicService.getById(topicId);
        if (existingTopic == null) {
            response.put("code", 404);
            response.put("message", "主题不存在");
            return response;
        }
        
        // 更新主题名称
        Topic topic = new Topic();
        topic.setId(topicId);
        topic.setName((String) params.get("name"));
        
        topicService.update(topic, "admin");
        
        response.put("code", 200);
        response.put("message", "更新成功");
        response.put("data", topic);
    } catch (Exception e) {
        response.put("code", 500);
        response.put("message", "更新失败：" + e.getMessage());
    }
    return response;
}
```

#### Service层
**文件**：`backed/src/main/java/com/knowledge/service/TopicService.java`

```java
public Topic update(Topic topic, String revisor) {
    topic.setRecRevisor(revisor);
    topicMapper.update(topic);
    return topic;
}
```

#### Mapper层
**文件**：`backed/src/main/resources/mapper/TopicMapper.xml`

```xml
<update id="update" parameterType="com.knowledge.entity.Topic">
    UPDATE km_topic
    SET name = #{name},
        rec_revisor = #{recRevisor},
        rec_revise_time = NOW()
    WHERE id = #{id}
</update>
```

## 🗃️ 数据库操作

### SQL更新语句
```sql
UPDATE km_topic
SET 
    name = '新的主题名称',
    rec_revisor = 'admin',
    rec_revise_time = NOW()
WHERE id = 'user-topic-123456';
```

## ✨ 特性说明

### 1. 实时更新
- 修改主题名称后，立即刷新前端显示
- 主题列表自动更新为最新数据

### 2. 数据一致性
- 由于移除了 `km_timeline_event` 表中的 `topic_name` 字段（已通过外键关联）
- 修改主题名称后，该主题下的所有里程碑会自动显示新名称（通过JOIN查询）
- 无需手动同步更新里程碑数据

### 3. 表单互斥
- 编辑主题时，自动关闭"新建主题"输入框
- 新建主题时，自动关闭"编辑主题"输入框
- 避免操作混乱

### 4. 输入验证
- 不允许提交空白主题名称
- 检测名称是否真的修改了（未修改则提示）
- 检查主题是否存在（后端验证）

## 🎯 使用场景

1. **修正拼写错误** - 创建主题时输入错误，可以快速修正
2. **优化命名** - 项目进行中发现更合适的命名
3. **统一规范** - 调整主题名称以符合命名规范
4. **语义调整** - 随着项目发展调整主题的描述

## 🔍 测试建议

### 功能测试
1. ✅ 选择主题后点击编辑按钮
2. ✅ 修改主题名称并保存
3. ✅ 验证主题列表中的名称已更新
4. ✅ 验证该主题下的里程碑显示新名称
5. ✅ 取消编辑操作
6. ✅ 尝试提交空白名称（应拦截）
7. ✅ 提交与原名称相同的名称（应提示）

### 异常测试
1. ⚠️ 网络异常情况下的错误提示
2. ⚠️ 主题不存在时的错误处理
3. ⚠️ 修改主题名称时主题被删除的情况

## 📅 版本信息

- **功能版本**：v1.7.0
- **实现日期**：2025-10-08
- **涉及模块**：
  - 前端：DailySummary.vue
  - 后端：TimelineEventController、TopicService、TopicMapper

## 🔗 相关功能

- [新建主题](./主题管理快速部署指南.md)
- [删除主题](./主题管理完整实现说明.md)
- [主题表优化](./数据库表优化说明.md)
- [时光轨迹功能](./时光轨迹功能部署说明.md)

## 💡 优化建议

### 未来可考虑的改进
1. **批量编辑** - 支持同时修改多个主题名称
2. **重命名历史** - 记录主题的修改历史
3. **权限控制** - 只允许创建者或管理员编辑
4. **实时校验** - 输入时检查名称是否重复
5. **拖拽排序** - 支持拖拽调整主题显示顺序

