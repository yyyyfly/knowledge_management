# 🖼️ 富文本编辑器图片支持说明

## 问题描述

富文本编辑器支持插入图片（通过上传或粘贴），图片会自动压缩并转换为Base64格式保存。但如果数据库字段类型为 `TEXT`，最多只能存储 **65KB** 的数据，对于包含多张图片或大图片的笔记，可能会导致数据被截断。

## 解决方案

将所有富文本字段从 `TEXT` 升级到 `MEDIUMTEXT`，支持最大 **16MB** 的数据存储。

## 执行步骤

### 1️⃣ 停止后端服务

在执行数据库升级前，建议先停止后端服务，避免数据不一致。

### 2️⃣ 执行 SQL 脚本

在 MySQL 中执行升级脚本：

```bash
# 方式一：命令行执行
mysql -u root -p knowledge_management < backed/src/main/resources/db/upgrade_note_fields_to_mediumtext.sql

# 方式二：MySQL 客户端执行
mysql -u root -p
USE knowledge_management;
SOURCE d:/项目本地/个人知识管理系统/backed/src/main/resources/db/upgrade_note_fields_to_mediumtext.sql
```

### 3️⃣ 验证升级结果

执行完脚本后，最后一条查询语句会显示所有 TEXT 类型字段，确认它们都已升级为 `MEDIUMTEXT`：

```
COLUMN_NAME                  | COLUMN_TYPE  | COLUMN_COMMENT
----------------------------|--------------|------------------
content                      | mediumtext   | 内容
core_concept                 | mediumtext   | 核心概念（富文本）
mechanism                    | mediumtext   | 机制原理（富文本）
...
```

### 4️⃣ 重启后端服务

升级完成后，重新启动后端服务。

## 涉及的字段

### 基础字段
- `content` - 通用内容字段（碎片笔记、框架笔记）

### 求学笔记（6个）
- `core_concept` - 核心概念
- `mechanism` - 机制原理
- `application_case` - 应用案例
- `extension` - 延伸/对比
- `common_mistake` - 常见误区
- `reflection` - 思考理解

### 背诵笔记（3个）
- `original_text` - 原文内容
- `explanation` - 解释说明
- `cue` - 记忆提示词

### 刷题笔记（3个）
- `question_description` - 题目描述
- `analysis` - 分析理解
- `reference_answer` - 参考答案

### 实战笔记（3个）
- `requirement_description` - 需求描述
- `design_thinking` - 设计思路
- `reference_design` - 参考设计

## 图片压缩策略

前端已经实现了自动图片压缩功能：

1. **自动缩放**：图片宽度超过 1200px 时按比例缩放
2. **质量压缩**：使用 80% 的 JPEG 质量
3. **支持粘贴**：直接 `Ctrl+V` 粘贴图片
4. **实时反馈**：控制台显示压缩前后的大小对比

### 示例效果

- 原始图片：2048KB
- 压缩后：456KB（压缩率 77.7%）

## 调试信息

保存笔记时，浏览器控制台（F12）会显示详细的调试信息：

```
刷题笔记保存数据检查: {
  questionDescription长度: 15000,
  包含图片: true,
  analysis长度: 2000,
  包含图片_分析: false,
  referenceAnswer长度: 3000,
  包含图片_答案: true
}
✅ 检测到图片数据，准备提交
准备提交的完整数据: {...}
数据大小 (字符数): 43891
=== 开始提交数据到服务器 ===
执行创建操作
服务器响应: {code: 200, data: {...}}
✅ 保存成功！新笔记ID: 123
```

## 常见问题

### Q1: 图片显示正常但保存后丢失？

**检查步骤：**
1. 打开浏览器控制台（F12）
2. 保存笔记时查看日志
3. 确认"包含图片"显示为 `true`
4. 确认"服务器响应"的 `code` 为 `200`
5. 检查数据库字段是否已升级为 `MEDIUMTEXT`

### Q2: 提示"保存成功"但图片还是没有？

**可能原因：**
1. 数据库字段类型仍为 `TEXT`，数据被截断
2. 后端接收到的数据不完整

**解决方法：**
1. 执行 SQL 升级脚本
2. 查看后端日志，确认收到的数据长度
3. 检查网络传输是否有大小限制（如 Nginx）

### Q3: 数据大小超过 16MB 怎么办？

如果笔记中图片太多，即使压缩后也可能超过 16MB，建议：

1. **分散图片**：将图片分散到多个笔记
2. **外部存储**：使用图床服务（如 图床API）存储图片，只保存URL
3. **进一步压缩**：降低图片质量或尺寸

**修改压缩参数（在 `MaterialRecord.vue`）：**
```javascript
// 找到 compressImage 函数，修改参数
const compressImage = (file: File, maxWidth: number = 800, quality: number = 0.6)
//                                               ↑ 宽度改为800    ↑ 质量降至60%
```

## 注意事项

1. ⚠️ **备份数据库**：执行 SQL 前建议备份数据库
2. ⚠️ **兼容性**：升级为 `MEDIUMTEXT` 不会影响现有数据
3. ⚠️ **磁盘空间**：确保服务器有足够的磁盘空间存储图片数据
4. ⚠️ **网络传输**：如果使用 Nginx，需要调整 `client_max_body_size`

## 版本信息

- 功能添加日期：2025-10-21
- 涉及版本：v2.4.0+
- 数据库要求：MySQL 5.7+














