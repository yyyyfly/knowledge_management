# 账号管理功能完整说明

## 功能概述

为个人知识管理系统添加了完整的账号管理功能，包括：
1. **注册优化**：要求填写邮箱等必要信息
2. **忘记密码**：通过用户名和邮箱验证重置密码
3. **账号设置**：用户可以修改个人信息和密码
4. **页面布局优化**：登录、注册、忘记密码页面不显示导航栏

## 一、注册功能优化

### 前端修改

**文件：`fronted/src/views/Register.vue`**
- ✅ 添加了 **邮箱** 字段（必填）
- ✅ 添加了 **手机号** 字段（可选）
- ✅ 邮箱格式验证
- ✅ 友好的提示信息

**表单字段：**
- 用户名（必填，3-20字符）
- 昵称（必填）
- **邮箱（必填，用于密码找回）** ⭐
- **手机号（可选）** ⭐
- 密码（必填，至少5字符）
- 确认密码（必填）

### 后端修改

**文件修改：**
- `backed/src/main/java/com/knowledge/controller/AuthController.java`
- `backed/src/main/java/com/knowledge/service/AuthService.java`
- `backed/src/main/java/com/knowledge/service/impl/AuthServiceImpl.java`
- `fronted/src/api/auth.ts`

**API变更：**
```java
// 新增email和phone参数
User register(String username, String password, String nickname, String email, String phone);
```

## 二、忘记密码功能

### 功能特点

- ✅ 用户名 + 邮箱双重验证
- ✅ 密码MD5加密存储
- ✅ 成功后自动跳转登录页
- ✅ 不显示导航栏（独立页面）

### 实现文件

**前端：**
- `fronted/src/views/ForgotPassword.vue` - 忘记密码页面
- `fronted/src/views/Login.vue` - 添加"忘记密码？"链接
- `fronted/src/router/index.ts` - 添加 `/forgot-password` 路由
- `fronted/src/api/auth.ts` - `resetPassword()` API调用

**后端：**
- `backed/src/main/java/com/knowledge/mapper/UserMapper.java` - 添加查询和更新方法
- `backed/src/main/resources/mapper/UserMapper.xml` - SQL映射
- `backed/src/main/java/com/knowledge/service/AuthService.java` - 业务接口
- `backed/src/main/java/com/knowledge/service/impl/AuthServiceImpl.java` - 业务实现
- `backed/src/main/java/com/knowledge/controller/AuthController.java` - REST接口
- `backed/src/main/java/com/knowledge/config/WebConfig.java` - 排除JWT拦截

**数据库：**
- `backed/src/main/resources/db/update_sys_user_for_password_reset.sql` - 确保email字段存在

### API接口

#### 重置密码
```http
POST /api/auth/reset-password
Content-Type: application/json

{
  "username": "admin",
  "email": "admin@example.com",
  "newPassword": "123456"
}
```

## 三、账号设置功能 ⭐

### 页面功能

**文件：`fronted/src/views/AccountSettings.vue`**

#### 1. 基本信息管理
- 用户名（只读，不可修改）
- 昵称（可修改）
- 邮箱（可修改）
- 手机号（可修改）

#### 2. 修改密码
- 输入原密码
- 输入新密码
- 确认新密码
- 验证原密码是否正确
- 密码长度至少6位

#### 3. 账号信息展示
- 账号状态
- 注册时间
- 最后登录时间

### 后端API

**新增Mapper方法：**
```java
// UserMapper.java
int updateUserInfo(User user);
```

**新增Service方法：**
```java
// AuthService.java
boolean updateUserInfo(User user);
boolean changePassword(String username, String oldPassword, String newPassword);
```

**新增Controller接口：**
```java
// AuthController.java
@PostMapping("/update-info")
public Result<User> updateUserInfo(@RequestBody User user, @RequestHeader("Authorization") String token)

@PostMapping("/change-password")
public Result<String> changePassword(@RequestBody Map<String, String> passwordRequest, @RequestHeader("Authorization") String token)
```

### API接口

#### 更新用户信息
```http
POST /api/auth/update-info
Authorization: Bearer {token}
Content-Type: application/json

{
  "nickname": "新昵称",
  "email": "newemail@example.com",
  "phone": "13800138000"
}
```

#### 修改密码
```http
POST /api/auth/change-password
Authorization: Bearer {token}
Content-Type: application/json

{
  "oldPassword": "旧密码",
  "newPassword": "新密码"
}
```

## 四、页面布局优化

### App.vue 修改

**文件：`fronted/src/App.vue`**

```typescript
// 不显示导航栏的页面：登录、注册、忘记密码
const isLoginPage = computed(() => 
  route.path === '/login' || 
  route.path === '/register' || 
  route.path === '/forgot-password'
)
```

这确保了登录、注册、忘记密码页面都是独立的全屏页面，不显示侧边栏和顶部导航栏。

## 五、路由配置

**文件：`fronted/src/router/index.ts`**

新增路由：
```typescript
{
  path: '/forgot-password',
  name: 'forgot-password',
  component: ForgotPassword,
  meta: { requiresAuth: false }
},
{
  path: '/account-settings',
  name: 'account-settings',
  component: () => import('@/views/AccountSettings.vue'),
  meta: { requiresAuth: true }
}
```

路由守卫更新：
```typescript
// 允许未登录用户访问：登录、注册、忘记密码
if (to.path === '/login' || to.path === '/register' || to.path === '/forgot-password') {
  if (token) {
    next('/') // 已登录，跳转到首页
  } else {
    next() // 未登录，允许访问
  }
  return
}
```

## 六、侧边栏菜单

**文件：`fronted/src/components/Sidebar.vue`**

在"系统配置"分组下添加了"账号设置"入口：
```
系统配置
  ├── 系统概述
  ├── 版本更新
  └── 账号设置  ⭐ 新增
```

## 七、数据库更新

### 执行SQL

```bash
mysql -u root -p knowledge_management < backed/src/main/resources/db/update_sys_user_for_password_reset.sql
```

### SQL内容

**文件：`backed/src/main/resources/db/update_sys_user_for_password_reset.sql`**

- 创建或更新 `sys_user` 表
- 确保 `email` 和 `phone` 字段存在
- 为 admin 用户设置默认邮箱：`admin@example.com`
- 创建必要的索引

## 八、使用流程

### 1. 新用户注册

1. 访问 `http://localhost:5173/register`
2. 填写信息：
   - 用户名：yourname
   - 昵称：您的昵称
   - **邮箱：youremail@example.com** （必填）
   - 手机号：13800138000（可选）
   - 密码：至少5位
   - 确认密码
3. 提交注册
4. 自动跳转到登录页

### 2. 忘记密码

1. 在登录页点击"忘记密码？"
2. 填写信息：
   - 用户名
   - 邮箱（必须与注册时一致）
   - 新密码（至少6位）
   - 确认新密码
3. 提交重置
4. 成功后自动跳转到登录页
5. 使用新密码登录

### 3. 修改个人信息

1. 登录后点击侧边栏的"系统配置" → "账号设置"
2. 修改昵称、邮箱或手机号
3. 点击"保存修改"
4. 成功提示，信息已更新

### 4. 修改密码（已登录）

1. 在"账号设置"页面右侧
2. 输入原密码
3. 输入新密码（至少6位）
4. 确认新密码
5. 点击"修改密码"
6. 成功提示，密码已更新

## 九、安全特性

1. **密码加密**：所有密码使用MD5加密存储
2. **双重验证**：忘记密码需要用户名+邮箱双重验证
3. **原密码验证**：修改密码时需要验证原密码
4. **用户隔离**：只能修改自己的信息（通过JWT token验证）
5. **邮箱验证**：邮箱格式验证，确保数据有效性

## 十、完整文件列表

### 新建文件

**前端：**
- `fronted/src/views/ForgotPassword.vue` - 忘记密码页面
- `fronted/src/views/AccountSettings.vue` - 账号设置页面

**后端：**
- `backed/src/main/resources/db/update_sys_user_for_password_reset.sql` - 数据库更新脚本

### 修改文件

**前端：**
- `fronted/src/App.vue` - 页面布局逻辑
- `fronted/src/views/Login.vue` - 添加忘记密码链接
- `fronted/src/views/Register.vue` - 添加邮箱和手机号字段
- `fronted/src/router/index.ts` - 添加新路由
- `fronted/src/api/auth.ts` - 添加API调用函数
- `fronted/src/components/Sidebar.vue` - 添加账号设置入口

**后端：**
- `backed/src/main/java/com/knowledge/mapper/UserMapper.java` - 添加查询和更新方法
- `backed/src/main/resources/mapper/UserMapper.xml` - 添加SQL映射
- `backed/src/main/java/com/knowledge/service/AuthService.java` - 添加业务方法
- `backed/src/main/java/com/knowledge/service/impl/AuthServiceImpl.java` - 实现业务逻辑
- `backed/src/main/java/com/knowledge/controller/AuthController.java` - 添加REST接口
- `backed/src/main/java/com/knowledge/config/WebConfig.java` - 更新JWT拦截器配置

## 十一、测试步骤

### 1. 测试注册（含邮箱）

```bash
# 测试数据
用户名：testuser
昵称：测试用户
邮箱：test@example.com
手机号：13800138000
密码：123456
```

预期：注册成功，自动跳转登录页

### 2. 测试忘记密码

```bash
# 使用刚注册的账号
用户名：testuser
邮箱：test@example.com
新密码：newpass123
```

预期：密码重置成功，可以用新密码登录

### 3. 测试账号设置

登录后：
- 访问 `http://localhost:5173/account-settings`
- 修改昵称为"新昵称"
- 修改邮箱为"newemail@example.com"
- 点击保存

预期：信息更新成功，页面显示成功提示

### 4. 测试修改密码

在账号设置页面：
- 原密码：当前密码
- 新密码：newpassword
- 确认密码：newpassword
- 点击修改

预期：密码修改成功，下次登录需要使用新密码

## 十二、错误处理

### 常见错误及解决

1. **"用户名或邮箱不正确"**
   - 原因：用户名和邮箱不匹配
   - 解决：确认注册时使用的邮箱

2. **"原密码错误"**
   - 原因：输入的原密码不正确
   - 解决：确认当前密码

3. **"两次输入的密码不一致"**
   - 原因：新密码和确认密码不匹配
   - 解决：重新输入确保一致

4. **"请输入有效的邮箱地址"**
   - 原因：邮箱格式不正确
   - 解决：输入正确的邮箱格式（example@domain.com）

## 十三、未来优化建议

1. **邮箱验证码**
   - 发送验证码到用户邮箱
   - 增加安全性

2. **头像上传**
   - 支持用户上传自定义头像
   - 文件存储方案

3. **双因素认证（2FA）**
   - 短信验证码
   - TOTP应用验证

4. **密码强度检测**
   - 实时显示密码强度
   - 要求更复杂的密码组合

5. **操作日志**
   - 记录账号修改历史
   - 异常登录提醒

## 十四、完成清单

- [x] 修改App.vue让忘记密码页面也不显示导航栏
- [x] 修改Register.vue添加邮箱等必填信息
- [x] 创建AccountSettings.vue账号管理页面
- [x] 在Sidebar添加账号管理入口
- [x] 添加账号管理路由配置
- [x] 后端添加更新用户信息API
- [x] 后端添加修改密码API
- [x] 创建数据库更新SQL脚本
- [x] 创建完整功能说明文档

---

**创建时间：** 2025-10-07  
**版本：** v1.3.0  
**状态：** ✅ 已完成

**功能模块：**
- 注册功能：✅ 完善（新增邮箱和手机号字段）
- 忘记密码：✅ 完成（邮箱验证重置）
- 账号设置：✅ 完成（个人信息管理 + 密码修改）
- 页面布局：✅ 优化（独立全屏页面设计）

## 版本更新记录

### v1.3.0 (2025-10-07)

**新增功能：**
- 账号设置：全新的账号管理页面，支持修改个人信息和密码
- 忘记密码：通过邮箱验证重置密码，保障账号安全
- 注册优化：新增邮箱必填项，手机号可选，为密码找回提供保障
- 用户信息完善：支持修改昵称、邮箱、手机号等个人资料

**优化改进：**
- 页面布局优化：登录、注册、忘记密码页面采用独立全屏设计
- 密码安全增强：修改密码需验证原密码，支持独立的密码重置流程
- 用户体验提升：实时表单验证，友好的错误提示和成功反馈
- 导航菜单完善：在系统配置下新增账号设置入口

**问题修复：**
- 修复注册时缺少邮箱字段导致无法找回密码的问题
- 修复忘记密码页面显示导航栏的问题
- 修复用户信息更新后本地存储不同步的问题
