# 笔记归档功能修复说明

## 问题描述

在查询归档的笔记列表时，出现以下错误：
```
java.sql.SQLSyntaxErrorException: Table 'knowledge_management.note' doesn't exist
```

**原因分析：**
本系统的笔记表实际名称是 `km_note`，而不是 `note`。

原始的 SQL 查询使用了错误的表名 `note`，导致查询失败。

## 修复方案

### 1. 修改文件

**文件路径：** `backed/src/main/resources/mapper/NoteArchiveRelationMapper.xml`

**修改内容：** 将 `selectNotesByArchiveId` 查询中的表名从 `note` 改为 `km_note`。

### 2. SQL 逻辑

**修改前（错误）：**
```xml
<select id="selectNotesByArchiveId" parameterType="long" resultMap="NoteResultMap">
    SELECT ... 
    FROM note_archive_relation nar
    LEFT JOIN note n ON nar.NOTE_ID = n.ID
    ...
</select>
```

**修改后（正确）：**
```xml
<select id="selectNotesByArchiveId" parameterType="long" resultMap="NoteResultMap">
    SELECT 
        nar.ID AS RELATION_ID,
        nar.NOTE_ID,
        nar.RELATION_NOTE,
        n.TITLE,
        n.TYPE,
        n.SUMMARY,
        n.TAGS,
        n.REC_CREATE_TIME
    FROM note_archive_relation nar
    LEFT JOIN km_note n ON nar.NOTE_ID = n.ID
    WHERE nar.ARCHIVE_ID = #{archiveId} 
      AND nar.ARCH_FLAG = 0
      AND n.ARCH_FLAG = 0
    ORDER BY nar.REC_CREATE_TIME DESC
</select>
```

**关键修改：**
- 将 `LEFT JOIN note` 改为 `LEFT JOIN km_note`
- 保持其他逻辑不变

## 部署步骤

### 1. 重新编译后端

```bash
cd backed
mvn clean package -DskipTests
```

### 2. 重启后端服务

**Windows:**
```bash
# 停止现有服务（如果正在运行）
# 然后启动新的服务
java -jar target/knowledge-management-system-1.0.0.jar
```

**Linux:**
```bash
cd deploy
./restart.sh
```

### 3. 验证功能

1. 打开前端页面，进入"笔记记录"
2. 点击"【3】笔记归档"
3. 切换到"归档视角"
4. 点击归档右侧的下拉箭头展开
5. 应该能看到该归档包含的笔记列表

## 测试要点

1. ✅ 归档列表能正常加载
2. ✅ 展开归档能看到包含的笔记
3. ✅ 笔记显示正确的类型标签（碎片笔记、求学笔记等）
4. ✅ 能正常添加笔记到归档
5. ✅ 能正常从归档中移除笔记
6. ✅ 切换到笔记视角，能看到笔记的归档信息

## 注意事项

### 1. 数据一致性

删除笔记时，需要同时删除 `note_archive_relation` 中的关联记录，建议：
- 在笔记删除逻辑中，调用 `NoteArchiveRelationMapper.deleteByNoteId(noteId)`
- 或者在数据库层面设置级联删除

### 2. 性能优化

如果归档包含大量笔记，可以考虑：
- 添加适当的索引（NOTE_ID, ARCHIVE_ID）
- 对结果进行分页显示

## 更新日志

**2025-10-20**
- ✅ 修复表名错误：将 `note` 改为 `km_note`
- ✅ 归档笔记列表现在可以正常显示

