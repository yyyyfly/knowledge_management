# 倒计时功能部署说明

## 功能概述

在数据概览页面顶部显示所有启用了倒计时的重要日期，帮助用户一眼看到即将到来或刚刚过去的重要事件。

## 功能特性

### 1. 智能过滤规则
- **只显示启用倒计时的事件**：在日历中添加日期时勾选"启用倒计时"的事件才会显示
- **过期隐藏规则**：
  - 过期0天（今天）：✅ 显示
  - 过期1天（昨天）：❌ 隐藏
  - 过期2天及以上：❌ 隐藏
- **自动排序**：按距离远近排序，最近的事件排在前面

### 2. 视觉效果

#### 倒计时卡片颜色分级
| 时间范围 | 边框颜色 | 文字颜色 | 图标 | 含义 |
|----------|----------|----------|------|------|
| 已过期（昨天及之前）| 灰色 | 灰色 | ⏰ | 已错过 |
| 今天 | 红色 | 红色 | 🎯 | 就是今天！|
| 1-3天内 | 橙色 | 橙色 | 🔥 | 紧急！|
| 4-7天内 | 橙色 | 橙色 | ⚠️ | 本周内 |
| 8-30天内 | 黄色 | 黄色 | 📅 | 本月内 |
| 30天以上 | 蓝色 | 蓝色 | 🗓️ | 还早 |

#### 空状态显示
当没有任何倒计时事件时，显示空状态提示：
- 📅 图标
- 提示文字："暂无重要日期倒计时"
- 引导文字："在'系统决策'页面的日历中添加日期并启用倒计时功能"

## UI设计

### 倒计时卡片布局
```
┌─────────────────────────────────┐
│ 🗓️ 重要日期倒计时                │
├─────────────────────────────────┤
│ ┌───────────────────────┐       │
│ │ 标题: 项目发布          │       │
│ │ 日期: 2025年10月15日    │       │
│ │                       │  🔥   │
│ │ [30] 天后              │       │
│ │ 描述: 重要项目发布...   │       │
│ └───────────────────────┘       │
└─────────────────────────────────┘
```

### 响应式布局
- **桌面端**：3列网格
- **平板端**：2列网格
- **手机端**：1列网格

## 数据流程

### 前端获取数据
```javascript
// 1. 调用API获取所有日历事件
const response = await request.get('/calendar/list')

// 2. 过滤启用倒计时的事件
const countdownEvents = allEvents.filter(event => event.showCountdown)

// 3. 计算距离天数
const daysUntil = Math.floor((eventDate - today) / (1000 * 60 * 60 * 24))

// 4. 过滤已过期超过1天的
const visibleEvents = events.filter(event => event.daysUntil >= -1)

// 5. 按距离排序
visibleEvents.sort((a, b) => a.daysUntil - b.daysUntil)
```

### 后端API
- **接口**：`GET /calendar/list`
- **返回字段**：
  ```json
  {
    "id": 1,
    "eventTitle": "项目发布",
    "eventDate": "2025-10-15",
    "eventType": "custom",
    "repeatType": "once",
    "description": "重要项目发布日",
    "color": "#3b82f6",
    "showCountdown": true
  }
  ```

## 实现细节

### 关键函数

#### 1. 加载倒计时事件
```javascript
const loadCountdownEvents = async () => {
  const response = await request.get('/calendar/list')
  const allEvents = response.data || []
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  
  countdownEvents.value = allEvents
    .filter(event => event.showCountdown)
    .map(event => ({
      ...event,
      daysUntil: Math.floor((new Date(event.eventDate) - today) / (1000 * 60 * 60 * 24))
    }))
    .filter(event => event.daysUntil >= -1)
    .sort((a, b) => a.daysUntil - b.daysUntil)
}
```

#### 2. 边框颜色判断
```javascript
const getDaysUntilClass = (days: number) => {
  if (days < 0) return 'border-gray-400'
  if (days === 0) return 'border-red-500'
  if (days <= 7) return 'border-orange-500'
  if (days <= 30) return 'border-yellow-500'
  return 'border-blue-500'
}
```

#### 3. 表情选择
```javascript
const getEventEmoji = (days: number) => {
  if (days < 0) return '⏰'
  if (days === 0) return '🎯'
  if (days <= 3) return '🔥'
  if (days <= 7) return '⚠️'
  if (days <= 30) return '📅'
  return '🗓️'
}
```

### 生命周期钩子
```javascript
onMounted(async () => {
  await loadData()
  await loadCountdownEvents() // 加载倒计时
})

onActivated(() => {
  loadData()
  loadCountdownEvents() // 页面激活时刷新
})
```

## 用户使用流程

### 1. 启用倒计时
1. 访问"系统决策"页面（`/headquarters/system-decisions`）
2. 点击"添加日期"
3. 填写事件标题、日期、描述等
4. **勾选"启用倒计时"开关** ✅
5. 保存

### 2. 查看倒计时
1. 访问"数据概览"页面（`/overview/data`）
2. 页面顶部会显示所有倒计时事件
3. 根据颜色和图标判断紧急程度

### 3. 过期自动隐藏
- 事件当天：✅ 继续显示（可能还在进行中）
- 事件过期1天后：❌ 自动隐藏

## 部署说明

### 前端部署
```bash
cd fronted
# 刷新浏览器即可看到新功能
```

### 数据库要求
确保 `km_calendar_event` 表已有 `show_countdown` 字段：
```sql
-- 如果没有，执行：
ALTER TABLE `km_calendar_event` 
ADD COLUMN `show_countdown` TINYINT(1) NOT NULL DEFAULT 0 
COMMENT '是否显示倒计时:0-否,1-是' 
AFTER `color`;
```

### 后端要求
- `CalendarEvent` 实体包含 `showCountdown` 字段
- `GET /calendar/list` API 返回完整的事件数据

## 测试场景

### 场景1：无倒计时事件
- **预期**：显示空状态提示
- **验证**：页面显示"暂无重要日期倒计时"

### 场景2：今天的事件
- **设置**：添加一个今天的事件，启用倒计时
- **预期**：显示红色边框，"0天后"，🎯图标

### 场景3：明天的事件
- **设置**：添加一个明天的事件，启用倒计时
- **预期**：显示橙色边框，"1天后"，🔥图标

### 场景4：昨天的事件（过期0天）
- **设置**：事件日期为昨天
- **预期**：✅ 仍然显示，灰色边框，"1天前"

### 场景5：前天的事件（过期1天）
- **设置**：事件日期为前天
- **预期**：❌ 自动隐藏，不显示

### 场景6：未启用倒计时的事件
- **设置**：添加事件但不勾选"启用倒计时"
- **预期**：❌ 不显示在倒计时列表中

## 技术要点

### 1. 日期计算精度
- 使用 `setHours(0, 0, 0, 0)` 确保精确到天
- 计算公式：`Math.floor((eventDate - today) / (1000 * 60 * 60 * 24))`

### 2. 响应式更新
- 页面激活时自动刷新（`onActivated`）
- 确保数据始终最新

### 3. 性能优化
- 前端过滤，减少数据传输
- 一次性排序，避免重复计算

## 相关文件

### 前端
- `fronted/src/views/overview/DataOverview.vue` - 主要实现文件
  - Line 3-45: 倒计时UI
  - Line 882: countdownEvents 数据
  - Line 1229-1287: 倒计时相关函数

### 后端
- `backed/src/main/java/com/knowledge/entity/CalendarEvent.java` - 实体类（包含 showCountdown）
- `backed/src/main/resources/mapper/CalendarEventMapper.xml` - 数据映射
- `backed/src/main/java/com/knowledge/controller/CalendarEventController.java` - API接口

### 数据库
- `backed/src/main/resources/db/km_calendar_event.sql` - 表结构（包含 show_countdown 字段）

## 已知问题与改进

### 当前限制
1. 不支持重复事件的倒计时计算
2. 时区固定为系统时区

### 未来改进方向
1. 支持自定义过期隐藏天数
2. 添加桌面通知功能
3. 支持倒计时卡片拖拽排序
4. 添加"查看全部历史倒计时"功能

