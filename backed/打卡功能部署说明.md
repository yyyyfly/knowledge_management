# 打卡功能部署说明

## 📋 功能概述

打卡功能允许用户创建打卡项目（日/周/月/季/年频率），并在项目执行页面进行打卡操作。每个周期只能打卡一次。

## 🗄️ 数据库部署

### 1. 创建打卡项目表

执行SQL文件：`backed/src/main/resources/db/km_checkin_item.sql`

```sql
-- 打卡项目表
CREATE TABLE IF NOT EXISTS `km_checkin_item` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `title` VARCHAR(100) NOT NULL COMMENT '打卡项目名称',
  `description` VARCHAR(500) DEFAULT NULL COMMENT '项目描述',
  `frequency` VARCHAR(20) NOT NULL DEFAULT 'daily' COMMENT '打卡频率:daily-日,weekly-周,monthly-月,quarterly-季,yearly-年',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `status` VARCHAR(20) NOT NULL DEFAULT 'active' COMMENT '状态:active-启用,inactive-停用',
  `rec_creator` VARCHAR(50) DEFAULT NULL COMMENT '记录创建人',
  `rec_create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  `rec_revisor` VARCHAR(50) DEFAULT NULL COMMENT '记录修改人',
  `rec_revise_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '记录修改时间',
  `arch_flag` TINYINT(1) DEFAULT 0 COMMENT '归档标志:0-未归档,1-已归档',
  PRIMARY KEY (`id`),
  KEY `idx_username` (`username`),
  KEY `idx_status` (`status`),
  KEY `idx_frequency` (`frequency`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='打卡项目表';
```

### 2. 创建打卡记录表

执行SQL文件：`backed/src/main/resources/db/km_checkin_record.sql`

```sql
-- 打卡记录表
CREATE TABLE IF NOT EXISTS `km_checkin_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `checkin_item_id` BIGINT NOT NULL COMMENT '打卡项目ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `checkin_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '打卡时间',
  `cycle_key` VARCHAR(50) NOT NULL COMMENT '周期标识(如:2025-10-11,2025-W41,2025-10,2025-Q4,2025)',
  `rec_creator` VARCHAR(50) DEFAULT NULL COMMENT '记录创建人',
  `rec_create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  `rec_revisor` VARCHAR(50) DEFAULT NULL COMMENT '记录修改人',
  `rec_revise_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '记录修改时间',
  `arch_flag` TINYINT(1) DEFAULT 0 COMMENT '归档标志:0-未归档,1-已归档',
  PRIMARY KEY (`id`),
  KEY `idx_checkin_item_id` (`checkin_item_id`),
  KEY `idx_username` (`username`),
  KEY `idx_cycle_key` (`cycle_key`),
  KEY `idx_checkin_time` (`checkin_time`),
  UNIQUE KEY `uk_item_user_cycle` (`checkin_item_id`, `username`, `cycle_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='打卡记录表';
```

## 🚀 后端部署

### 1. 重新编译项目

```bash
cd backed
mvn clean package
```

### 2. 重启后端服务

重启Spring Boot应用即可。

## 📦 新增的后端文件

### 实体类
- `backed/src/main/java/com/knowledge/entity/CheckinItem.java`
- `backed/src/main/java/com/knowledge/entity/CheckinRecord.java`

### Mapper接口
- `backed/src/main/java/com/knowledge/mapper/CheckinItemMapper.java`
- `backed/src/main/java/com/knowledge/mapper/CheckinRecordMapper.java`

### Mapper XML
- `backed/src/main/resources/mapper/CheckinItemMapper.xml`
- `backed/src/main/resources/mapper/CheckinRecordMapper.xml`

### Service层
- `backed/src/main/java/com/knowledge/service/CheckinItemService.java`
- `backed/src/main/java/com/knowledge/service/CheckinRecordService.java`

### Controller层
- `backed/src/main/java/com/knowledge/controller/CheckinItemController.java`
- `backed/src/main/java/com/knowledge/controller/CheckinRecordController.java`

## 🎨 前端部署

前端无需额外部署，已自动更新：
- `fronted/src/api/checkin.ts` - API接口封装
- `fronted/src/views/headquarters/SystemDecisions.vue` - 打卡管理界面
- `fronted/src/views/daily/ProjectRecord.vue` - 打卡操作界面

## 📚 API接口说明

### 打卡项目管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建打卡项目 | POST | `/api/checkin/item` | 创建新的打卡项目 |
| 获取打卡项目列表 | GET | `/api/checkin/item/list` | 获取当前用户的所有打卡项目 |
| 根据状态获取 | GET | `/api/checkin/item/list/{status}` | 获取指定状态的打卡项目 |
| 获取单个项目 | GET | `/api/checkin/item/{id}` | 根据ID获取打卡项目 |
| 更新打卡项目 | PUT | `/api/checkin/item/{id}` | 更新打卡项目信息 |
| 删除打卡项目 | DELETE | `/api/checkin/item/{id}` | 删除打卡项目 |

### 打卡记录管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 打卡 | POST | `/api/checkin/record/checkin/{itemId}` | 对指定项目进行打卡 |
| 取消打卡 | DELETE | `/api/checkin/record/cancel/{itemId}` | 取消本周期的打卡 |
| 检查打卡状态 | GET | `/api/checkin/record/status/{itemId}?frequency={frequency}` | 检查是否已打卡 |
| 获取打卡记录 | GET | `/api/checkin/record/list/{itemId}` | 获取项目的所有打卡记录 |

## 🎯 使用说明

### 1. 创建打卡项目

1. 访问 `http://localhost:5173/system-decisions`
2. 展开"打卡管理"卡片
3. 点击"添加打卡项目"按钮
4. 填写项目信息：
   - 项目名称（必填）
   - 项目描述（可选）
   - 打卡频率（必选）：日/周/月/季/年
5. 点击"添加项目"保存

### 2. 执行打卡

1. 访问 `http://localhost:5173/daily/project-record`
2. 点击"打卡操作"选项卡
3. 查看所有启用的打卡项目
4. 点击"打卡"按钮完成打卡
5. 已打卡项目显示绿色，可点击"已打卡 - 点击取消"来取消

### 3. 周期规则

- **日**：每天0点重置，可以打卡一次
- **周**：每周一0点重置（按ISO周计算）
- **月**：每月1日0点重置
- **季**：每季度第一天0点重置（1月1日、4月1日、7月1日、10月1日）
- **年**：每年1月1日0点重置

### 4. 周期标识说明

系统自动计算周期标识，格式如下：
- 日：`2025-10-11`
- 周：`2025-W41`
- 月：`2025-10`
- 季：`2025-Q4`
- 年：`2025`

数据库通过 `(checkin_item_id, username, cycle_key)` 唯一约束确保同一周期只能打卡一次。

## ⚠️ 注意事项

1. **数据库字段类型**：
   - 系统使用用户名（username VARCHAR(50)）而非用户ID
   - rec_creator 和 rec_revisor 也是 VARCHAR(50)

2. **权限控制**：
   - 所有接口都需要JWT认证
   - 用户只能操作自己的打卡项目和记录

3. **周期计算**：
   - 周计算基于ISO标准（每周从周一开始）
   - 使用中国时区进行周的计算

4. **状态管理**：
   - 打卡项目有两种状态：active（启用）、inactive（停用）
   - 只有启用状态的项目才会在打卡操作界面显示

## 🐛 常见问题

### Q1: 打卡按钮不可点击？
A: 检查该项目本周期是否已打卡。每个周期只能打卡一次。

### Q2: 取消打卡后能再次打卡吗？
A: 可以。取消打卡后，当前周期内可以再次打卡。

### Q3: 如何修改打卡频率？
A: 在系统决策页面编辑打卡项目，修改频率后保存。注意：修改频率后，周期标识会重新计算。

### Q4: 打卡记录会保留多久？
A: 打卡记录永久保留，除非手动删除打卡项目（逻辑删除）。

### Q5: 出现"Duplicate entry for key 'uk_item_user_cycle'"错误？
A: 这是因为取消打卡后尝试再次打卡时，数据库中仍存在归档的旧记录。解决方法：
1. 执行清理脚本：`backed/打卡记录重复问题修复.sql`
2. 重启后端服务
3. 问题已在 v1.0.1 版本修复（取消打卡改为物理删除）

## 📝 更新日志

### v1.0.1 (2025-10-11)
- 🐛 修复：取消打卡后再次打卡时出现唯一键冲突的问题
- 🔄 变更：取消打卡操作从逻辑删除改为物理删除
- 📝 新增：打卡记录重复问题修复脚本

### v1.0.0 (2025-10-11)
- ✅ 初始版本发布
- ✅ 支持5种打卡频率（日/周/月/季/年）
- ✅ 支持打卡和取消打卡
- ✅ 周期内只能打卡一次的限制
- ✅ 打卡项目的启用/停用管理

