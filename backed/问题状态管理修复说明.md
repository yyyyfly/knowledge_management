# 问题状态管理修复说明

## 🐛 问题描述

### 错误信息
```
Column 'status' cannot be null
### Error updating database.  Cause: java.sql.SQLIntegrityConstraintViolationException
```

### 问题原因
1. **缺少状态字段**：`issueForm` 对象缺少 `status` 字段
2. **编辑时未赋值**：编辑问题时没有将原问题的状态赋值给表单
3. **关闭时未重置**：关闭弹窗时没有重置状态字段
4. **UI缺少状态选择**：编辑问题时用户无法修改问题状态

## ✅ 修复方案

### 1. 添加 status 字段到表单对象

**修改前**：
```javascript
const issueForm = reactive({
  projectId: '',
  issueTitle: '',
  issueDescription: '',
  issueType: 'technical',
  priority: 'medium'
  // ❌ 缺少 status 字段
})
```

**修改后**：
```javascript
const issueForm = reactive({
  projectId: '',
  issueTitle: '',
  issueDescription: '',
  issueType: 'technical',
  priority: 'medium',
  status: 'open' // ✅ 添加 status 字段，默认为 'open'
})
```

### 2. 编辑时赋值状态

**修改前**：
```javascript
const editIssue = (issue: any) => {
  issueForm.projectId = issue.projectId.toString()
  issueForm.issueTitle = issue.issueTitle
  issueForm.issueDescription = issue.issueDescription
  issueForm.issueType = issue.issueType
  issueForm.priority = issue.priority
  // ❌ 未设置 status
  currentIssue.value = issue
  showCreateIssue.value = true
}
```

**修改后**：
```javascript
const editIssue = (issue: any) => {
  issueForm.projectId = issue.projectId.toString()
  issueForm.issueTitle = issue.issueTitle
  issueForm.issueDescription = issue.issueDescription
  issueForm.issueType = issue.issueType
  issueForm.priority = issue.priority
  issueForm.status = issue.status || 'open' // ✅ 设置 status
  currentIssue.value = issue
  showCreateIssue.value = true
}
```

### 3. 关闭时重置状态

**修改前**：
```javascript
const closeCreateIssue = () => {
  showCreateIssue.value = false
  currentIssue.value = null
  issueForm.projectId = ''
  issueForm.issueTitle = ''
  issueForm.issueDescription = ''
  issueForm.issueType = 'technical'
  issueForm.priority = 'medium'
  // ❌ 未重置 status
}
```

**修改后**：
```javascript
const closeCreateIssue = () => {
  showCreateIssue.value = false
  currentIssue.value = null
  issueForm.projectId = ''
  issueForm.issueTitle = ''
  issueForm.issueDescription = ''
  issueForm.issueType = 'technical'
  issueForm.priority = 'medium'
  issueForm.status = 'open' // ✅ 重置 status
}
```

### 4. UI 添加状态选择（编辑模式）

**新增代码**：
```html
<!-- 问题状态（编辑时显示） -->
<div v-if="currentIssue">
  <label class="block text-sm font-medium text-gray-700 mb-2">问题状态 *</label>
  <div class="grid grid-cols-3 gap-3">
    <!-- 待处理 -->
    <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-all"
      :class="issueForm.status === 'open' ? 'border-gray-500 bg-gray-50' : 'border-gray-300 hover:border-gray-400'">
      <input type="radio" v-model="issueForm.status" value="open" class="hidden">
      <span class="text-sm font-medium" :class="issueForm.status === 'open' ? 'text-gray-700' : 'text-gray-600'">⏸️ 待处理</span>
    </label>
    
    <!-- 处理中 -->
    <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-all"
      :class="issueForm.status === 'in_progress' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-blue-300'">
      <input type="radio" v-model="issueForm.status" value="in_progress" class="hidden">
      <span class="text-sm font-medium" :class="issueForm.status === 'in_progress' ? 'text-blue-700' : 'text-gray-700'">🔄 处理中</span>
    </label>
    
    <!-- 已解决 -->
    <label class="flex items-center justify-center p-3 border-2 rounded-lg cursor-pointer transition-all"
      :class="issueForm.status === 'resolved' ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-green-300'">
      <input type="radio" v-model="issueForm.status" value="resolved" class="hidden">
      <span class="text-sm font-medium" :class="issueForm.status === 'resolved' ? 'text-green-700' : 'text-gray-700'">✅ 已解决</span>
    </label>
  </div>
</div>
```

## 🎯 问题状态说明

### 三种状态

| 状态 | 值 | 图标 | 颜色 | 说明 |
|-----|-----|-----|-----|-----|
| 待处理 | `open` | ⏸️ | 灰色 | 问题刚记录或被退回重新处理 |
| 处理中 | `in_progress` | 🔄 | 蓝色 | 问题正在处理中 |
| 已解决 | `resolved` | ✅ | 绿色 | 问题已有解决方案 |

### 状态流转规则

```
新建问题 → open（待处理）
    ↓
open → in_progress（决策端标记处理中）
    ↓
in_progress → resolved（决策端提交解决方案）
    ↓
resolved → open（退回重新处理）
```

### 编辑时的状态控制

1. **新建问题**：
   - 不显示状态选择
   - 自动设置为 `open`

2. **编辑问题**：
   - 显示状态选择
   - 可以手动修改状态
   - 支持三种状态切换

3. **状态修改场景**：
   - 将待处理改为处理中
   - 将处理中改为已解决
   - 将已解决退回待处理

## 🚀 使用示例

### 场景1：新建问题
1. 点击"记录问题"
2. 填写表单（不显示状态选择）
3. 提交后自动设为"待处理"

### 场景2：编辑问题状态
1. 点击问题卡片的"编辑"按钮
2. 看到状态选择区域（三个单选按钮）
3. 选择新的状态
4. 点击"保存修改"

### 场景3：手动推进状态
1. 编辑问题
2. 将"待处理" → "处理中"
3. 保存
4. 再次编辑
5. 将"处理中" → "已解决"

## ✨ UI/UX 改进

### 视觉反馈
- **选中状态**：边框和背景高亮
- **未选中状态**：灰色边框，悬停高亮
- **图标提示**：每个状态都有对应的 emoji 图标

### 交互设计
- **单选按钮**：同一时间只能选择一个状态
- **条件显示**：只在编辑模式显示状态选择
- **默认值保护**：编辑时自动填充当前状态

## 🔧 技术细节

### 数据库约束
```sql
`status` VARCHAR(20) NOT NULL DEFAULT 'open'
```
- **NOT NULL**：状态字段不能为空
- **DEFAULT 'open'**：默认值为待处理

### 前端验证
- 新建时：自动设置为 `open`
- 编辑时：从原问题获取，如果为空则默认 `open`
- 提交时：确保 status 字段存在且有值

### 后端处理
- 更新问题时包含 status 字段
- 状态值为枚举类型：`open`, `in_progress`, `resolved`

## 📝 测试清单

- [x] 新建问题时 status 自动为 'open'
- [x] 编辑问题时显示状态选择
- [x] 编辑问题时状态正确回显
- [x] 修改状态后能成功保存
- [x] 关闭弹窗后状态重置为 'open'
- [x] 数据库更新不再报 "Column 'status' cannot be null" 错误

## 🎉 修复效果

### 修复前
- ❌ 编辑问题报错：`Column 'status' cannot be null`
- ❌ 无法手动修改问题状态
- ❌ 状态字段缺失导致数据不完整

### 修复后
- ✅ 编辑问题正常保存
- ✅ 可以手动修改问题状态
- ✅ 状态字段完整，数据一致性得到保证
- ✅ UI 提供清晰的状态选择界面

---

*修复时间：2025-10-09*  
*涉及文件：fronted/src/views/daily/ProjectRecord.vue*


