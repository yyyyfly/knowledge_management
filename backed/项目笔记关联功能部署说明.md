# é¡¹ç›®ç¬”è®°å…³è”åŠŸèƒ½éƒ¨ç½²è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

é¡¹ç›®ç¬”è®°å…³è”åŠŸèƒ½å…è®¸ä¸ºé¡¹ç›®å…³è”ç›¸å…³çš„ç¬”è®°ï¼Œæ–¹ä¾¿åœ¨é¡¹ç›®æ‰§è¡Œæ—¶å¿«é€Ÿè°ƒç”¨ç›¸å…³çŸ¥è¯†å’Œèµ„æ–™ã€‚

## ğŸ—„ï¸ æ•°æ®åº“éƒ¨ç½²

### 1. æ‰§è¡ŒSQLè„šæœ¬

æ‰§è¡Œæ–‡ä»¶ï¼š`backed/create_project_note_relation_table.sql`

```sql
-- åˆ›å»ºé¡¹ç›®ç¬”è®°å…³è”è¡¨
CREATE TABLE IF NOT EXISTS project_note_relation (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    project_id INT NOT NULL COMMENT 'é¡¹ç›®ID',
    note_id INT NOT NULL COMMENT 'ç¬”è®°ID',
    note_type VARCHAR(50) NOT NULL COMMENT 'ç¬”è®°ç±»å‹',
    rec_creator VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    rec_create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    rec_revisor VARCHAR(50) COMMENT 'ä¿®æ”¹äºº',
    rec_revise_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´',
    arch_flag CHAR(1) DEFAULT '1' COMMENT 'å½’æ¡£æ ‡å¿—',
    UNIQUE KEY uk_project_note (project_id, note_id),
    INDEX idx_project (project_id),
    INDEX idx_note (note_id),
    INDEX idx_note_type (note_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é¡¹ç›®ç¬”è®°å…³è”è¡¨';
```

### 2. éªŒè¯è¡¨åˆ›å»º

```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
DESC project_note_relation;

-- æŸ¥çœ‹ç´¢å¼•
SHOW INDEX FROM project_note_relation;
```

## ğŸ“ åç«¯ä»£ç æ–‡ä»¶

### æ–°å¢æ–‡ä»¶åˆ—è¡¨

1. **å®ä½“ç±»**
   - `backed/src/main/java/com/knowledge/entity/ProjectNoteRelation.java`

2. **Mapperæ¥å£**
   - `backed/src/main/java/com/knowledge/mapper/ProjectNoteRelationMapper.java`

3. **Mapper XML**
   - `backed/src/main/resources/mapper/ProjectNoteRelationMapper.xml`

4. **ServiceæœåŠ¡ç±»**
   - `backed/src/main/java/com/knowledge/service/ProjectNoteRelationService.java`

5. **Controlleræ›´æ–°**
   - `backed/src/main/java/com/knowledge/controller/ProjectController.java`ï¼ˆå·²ä¿®æ”¹ï¼‰

## ğŸ”Œ APIæ¥å£è¯´æ˜

### 1. è·å–é¡¹ç›®å…³è”çš„ç¬”è®°IDåˆ—è¡¨

```http
GET /project/{projectId}/notes
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": [1, 5, 8, 12]
}
```

### 2. æ·»åŠ ç¬”è®°åˆ°é¡¹ç›®

```http
POST /project/{projectId}/notes
Content-Type: application/json

{
    "noteId": 5,
    "noteType": "framework"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "ç¬”è®°å·²å…³è”åˆ°é¡¹ç›®",
    "data": null
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
    "code": 500,
    "message": "ç¬”è®°å·²ç»å…³è”åˆ°è¯¥é¡¹ç›®",
    "data": null
}
```

### 3. ä»é¡¹ç›®ç§»é™¤ç¬”è®°

```http
DELETE /project/{projectId}/notes/{noteId}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "å·²ç§»é™¤ç¬”è®°å…³è”",
    "data": null
}
```

### 4. è·å–é¡¹ç›®çš„ç¬”è®°æ•°é‡

```http
GET /project/{projectId}/notes/count
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": 5
}
```

### 5. è·å–ç¬”è®°å…³è”çš„é¡¹ç›®IDåˆ—è¡¨

```http
GET /project/notes/{noteId}/projects
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
    "code": 200,
    "message": "success",
    "data": [2, 7, 15]
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ•°æ®åº“éƒ¨ç½²

```bash
# è¿æ¥MySQL
mysql -u root -p

# é€‰æ‹©æ•°æ®åº“
use knowledge_management;

# æ‰§è¡ŒSQLè„šæœ¬
source /path/to/backed/create_project_note_relation_table.sql;

# éªŒè¯åˆ›å»ºæˆåŠŸ
DESC project_note_relation;
```

### 2. åç«¯ä»£ç éƒ¨ç½²

#### æ–¹å¼ä¸€ï¼šå®Œæ•´é‡æ–°ç¼–è¯‘ï¼ˆæ¨èï¼‰

```bash
cd backed

# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
mvn clean package -DskipTests

# åœæ­¢æ—§æœåŠ¡
./stop.sh

# å¯åŠ¨æ–°æœåŠ¡
./start.sh
```

#### æ–¹å¼äºŒï¼šå¿«é€Ÿçƒ­éƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

å¦‚æœä½¿ç”¨IDEï¼ˆå¦‚IntelliJ IDEAï¼‰ï¼š
1. ç›´æ¥è¿è¡Œä¸»ç±» `KnowledgeManagementApplication`
2. IDEä¼šè‡ªåŠ¨ç¼–è¯‘æ–°å¢çš„ç±»

### 3. éªŒè¯éƒ¨ç½²

#### æµ‹è¯•APIæ¥å£

```bash
# 1. è·å–é¡¹ç›®1çš„å…³è”ç¬”è®°ï¼ˆåº”è¯¥è¿”å›ç©ºæ•°ç»„ï¼‰
curl http://localhost:8080/project/1/notes

# 2. æ·»åŠ ç¬”è®°5åˆ°é¡¹ç›®1
curl -X POST http://localhost:8080/project/1/notes \
  -H "Content-Type: application/json" \
  -d '{"noteId": 5, "noteType": "framework"}'

# 3. å†æ¬¡è·å–é¡¹ç›®1çš„å…³è”ç¬”è®°ï¼ˆåº”è¯¥è¿”å›[5]ï¼‰
curl http://localhost:8080/project/1/notes

# 4. è·å–ç¬”è®°æ•°é‡
curl http://localhost:8080/project/1/notes/count

# 5. ç§»é™¤å…³è”
curl -X DELETE http://localhost:8080/project/1/notes/5
```

#### æŸ¥çœ‹æ•°æ®åº“

```sql
-- æŸ¥çœ‹å…³è”è®°å½•
SELECT * FROM project_note_relation;

-- æŸ¥çœ‹æŸä¸ªé¡¹ç›®çš„å…³è”
SELECT * FROM project_note_relation WHERE project_id = 1;

-- æŸ¥çœ‹æŸä¸ªç¬”è®°çš„å…³è”
SELECT * FROM project_note_relation WHERE note_id = 5;
```

## ğŸ“Š æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### 1. ProjectNoteRelationService æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³•å | åŠŸèƒ½ | è¿”å›å€¼ |
|--------|------|--------|
| `getNoteIdsByProjectId` | è·å–é¡¹ç›®çš„ç¬”è®°IDåˆ—è¡¨ | `List<Integer>` |
| `getProjectIdsByNoteId` | è·å–ç¬”è®°çš„é¡¹ç›®IDåˆ—è¡¨ | `List<Integer>` |
| `addProjectNoteRelation` | æ·»åŠ é¡¹ç›®ç¬”è®°å…³è” | `boolean` |
| `removeProjectNoteRelation` | åˆ é™¤æŒ‡å®šå…³è” | `boolean` |
| `removeAllNotesByProjectId` | åˆ é™¤é¡¹ç›®çš„æ‰€æœ‰ç¬”è®°å…³è” | `int` |
| `removeAllProjectsByNoteId` | åˆ é™¤ç¬”è®°çš„æ‰€æœ‰é¡¹ç›®å…³è” | `int` |
| `countNotesByProjectId` | è·å–é¡¹ç›®çš„ç¬”è®°æ•°é‡ | `int` |
| `countProjectsByNoteId` | è·å–ç¬”è®°çš„é¡¹ç›®æ•°é‡ | `int` |
| `isRelated` | æ£€æŸ¥æ˜¯å¦å·²å…³è” | `boolean` |

### 2. æ•°æ®ä¸€è‡´æ€§ä¿è¯

- âœ… ä½¿ç”¨ `UNIQUE KEY` é˜²æ­¢é‡å¤å…³è”
- âœ… ä½¿ç”¨ `@Transactional` ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§
- âœ… æ·»åŠ å‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å…³è”
- âœ… æ”¯æŒçº§è”åˆ é™¤ï¼ˆå¯é€‰ï¼‰

### 3. æ€§èƒ½ä¼˜åŒ–

- âœ… åœ¨ `project_id` å’Œ `note_id` ä¸Šå»ºç«‹ç´¢å¼•
- âœ… ä½¿ç”¨ `arch_flag` è½¯åˆ é™¤æœºåˆ¶
- âœ… æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²å½’æ¡£è®°å½•

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. è¡¨åˆ›å»ºå¤±è´¥

**é—®é¢˜**ï¼šæ‰§è¡ŒSQLæ—¶æç¤ºè¡¨å·²å­˜åœ¨
```
ERROR 1050 (42S01): Table 'project_note_relation' already exists
```

**è§£å†³**ï¼š
```sql
-- åˆ é™¤æ—§è¡¨ï¼ˆæ³¨æ„ï¼šä¼šä¸¢å¤±æ•°æ®ï¼‰
DROP TABLE IF EXISTS project_note_relation;

-- é‡æ–°æ‰§è¡Œåˆ›å»ºè„šæœ¬
source create_project_note_relation_table.sql;
```

### 2. MyBatisæ˜ å°„æ‰¾ä¸åˆ°

**é—®é¢˜**ï¼šå¯åŠ¨æ—¶æŠ¥é”™æ‰¾ä¸åˆ°Mapper
```
org.apache.ibatis.binding.BindingException: Invalid bound statement
```

**è§£å†³**ï¼š
1. æ£€æŸ¥ `application.properties` ä¸­çš„mapperé…ç½®ï¼š
```properties
mybatis.mapper-locations=classpath:mapper/*.xml
```

2. ç¡®ä¿XMLæ–‡ä»¶åœ¨ `src/main/resources/mapper/` ç›®å½•ä¸‹

3. é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼š
```bash
mvn clean compile
```

### 3. æ·»åŠ å…³è”æ—¶æŠ¥é”™

**é—®é¢˜**ï¼šæ·»åŠ æ—¶æç¤º "ç¬”è®°å·²ç»å…³è”åˆ°è¯¥é¡¹ç›®"

**åŸå› **ï¼šæ•°æ®åº“ä¸­å·²å­˜åœ¨è¯¥å…³è”è®°å½•

**è§£å†³**ï¼š
```sql
-- æŸ¥çœ‹æ˜¯å¦å·²å­˜åœ¨
SELECT * FROM project_note_relation 
WHERE project_id = ? AND note_id = ?;

-- å¦‚éœ€åˆ é™¤
DELETE FROM project_note_relation 
WHERE project_id = ? AND note_id = ?;
```

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ‰¹é‡æ“ä½œæ”¯æŒ

```java
// æ·»åŠ åˆ°Serviceä¸­
public boolean addNotesToProject(Integer projectId, List<Integer> noteIds, String username);
public int removeNotesFromProject(Integer projectId, List<Integer> noteIds);
```

### 2. å…³è”å…³ç³»å…ƒæ•°æ®

å¯æ‰©å±•å­—æ®µï¼š
- `relation_desc` - å…³è”è¯´æ˜
- `importance` - é‡è¦ç¨‹åº¦ï¼ˆ1-5æ˜Ÿï¼‰
- `tags` - è‡ªå®šä¹‰æ ‡ç­¾
- `order_num` - æ’åºåºå·

### 3. å…³è”ç»Ÿè®¡åˆ†æ

```java
// ç»Ÿè®¡æœ€å¸¸è¢«å…³è”çš„ç¬”è®°
List<Map<String, Object>> getMostReferencedNotes(int limit);

// ç»Ÿè®¡é¡¹ç›®çš„ç¬”è®°ç±»å‹åˆ†å¸ƒ
Map<String, Integer> getNoteTypeDistribution(Integer projectId);
```

### 4. çº§è”åˆ é™¤ç­–ç•¥

è€ƒè™‘åœ¨åˆ é™¤é¡¹ç›®æˆ–ç¬”è®°æ—¶ï¼Œæ˜¯å¦è‡ªåŠ¨æ¸…ç†å…³è”å…³ç³»ï¼š

```java
// åœ¨ProjectServiceä¸­æ·»åŠ 
@Transactional
public boolean deleteProject(Integer projectId) {
    // å…ˆåˆ é™¤å…³è”
    projectNoteRelationService.removeAllNotesByProjectId(projectId);
    // å†åˆ é™¤é¡¹ç›®
    return projectMapper.deleteByPrimaryKey(projectId) > 0;
}
```

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] èƒ½æˆåŠŸæ·»åŠ ç¬”è®°åˆ°é¡¹ç›®
- [ ] èƒ½æŸ¥è¯¢é¡¹ç›®çš„æ‰€æœ‰å…³è”ç¬”è®°
- [ ] èƒ½ç§»é™¤ç¬”è®°å…³è”
- [ ] é‡å¤æ·»åŠ æ—¶æ­£ç¡®æç¤º
- [ ] åˆ é™¤ä¸å­˜åœ¨çš„å…³è”æ—¶æ­£ç¡®å¤„ç†

### æ€§èƒ½éªŒæ”¶
- [ ] æŸ¥è¯¢100ä¸ªé¡¹ç›®çš„å…³è”ç¬”è®° < 1s
- [ ] æ·»åŠ å•ä¸ªå…³è” < 100ms
- [ ] åˆ é™¤å•ä¸ªå…³è” < 100ms

### æ•°æ®éªŒæ”¶
- [ ] å…³è”è®°å½•æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- [ ] rec_creator æ­£ç¡®è®°å½•å½“å‰ç”¨æˆ·
- [ ] rec_create_time è‡ªåŠ¨è®¾ç½®
- [ ] arch_flag é»˜è®¤ä¸º'1'

## ğŸ‰ å®Œæˆ

éƒ¨ç½²å®Œæˆåï¼Œå‰ç«¯çš„"ç¬”è®°è°ƒç”¨"åŠŸèƒ½å°†èƒ½æ­£å¸¸å·¥ä½œï¼Œå®ç°é¡¹ç›®-ç¬”è®°çš„å…³è”ç®¡ç†ï¼





















