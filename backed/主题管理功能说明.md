# 主题管理功能说明

## 功能概述

在"每日总结 > 历史事件记录 > 专项时间轴里程碑"中新增了主题管理功能，包括：
1. **新建主题**：创建新的时间轴主题，需要确认才能创建
2. **删除主题**：删除已有主题及其所有关联的里程碑事件（级联删除）

## 前端实现

### 文件修改
- `fronted/src/views/daily/DailySummary.vue`

### 新增功能

#### 1. 新建主题
- **位置**：选择主题/项目下拉框旁边的"新建主题"按钮
- **操作流程**：
  1. 点击"新建主题"按钮，显示输入框
  2. 输入主题名称
  3. 点击"确认"按钮（或按Enter键）创建主题
  4. 新主题自动添加到可选列表并自动选中
  5. 点击"取消"按钮可关闭输入框

#### 2. 删除主题
- **位置**：选择主题/项目下拉框旁边的删除按钮（红色垃圾桶图标）
- **操作流程**：
  1. 从下拉框选择要删除的主题
  2. 点击删除按钮
  3. 确认删除操作（会提示该操作将删除主题及其所有里程碑）
  4. 删除成功后自动刷新主题列表

### 关键代码

#### 确认新建主题
```typescript
const confirmNewTopic = () => {
  if (!milestoneForm.value.newTopicName.trim()) {
    alert('请输入主题名称')
    return
  }
  
  // 生成唯一的主题ID
  const newTopicId = `user-topic-${Date.now()}`
  
  // 添加到可用主题列表
  availableTopics.value.push({
    id: newTopicId,
    name: milestoneForm.value.newTopicName.trim()
  })
  
  // 自动选中新建的主题
  milestoneForm.value.topicId = newTopicId
  
  // 清空输入框并关闭
  milestoneForm.value.newTopicName = ''
  showNewTopicInput.value = false
  
  alert('✅ 新主题已创建并选中')
}
```

#### 删除主题
```typescript
const deleteTopic = async () => {
  if (!milestoneForm.value.topicId) {
    return
  }
  
  const selectedTopic = availableTopics.value.find(t => t.id === milestoneForm.value.topicId)
  if (!selectedTopic) {
    return
  }
  
  const confirmed = confirm(
    `⚠️ 确认删除主题「${selectedTopic.name}」吗？\n\n` +
    `注意：删除主题将同时删除该主题下的所有里程碑事件！\n` +
    `此操作无法撤销。`
  )
  
  if (!confirmed) {
    return
  }
  
  try {
    const response = await request.delete(`/timeline/topic/${milestoneForm.value.topicId}`)
    
    if (response.code === 200) {
      alert('✅ 主题及其所有里程碑已删除')
      
      // 从列表中移除
      availableTopics.value = availableTopics.value.filter(t => t.id !== milestoneForm.value.topicId)
      
      // 清空选中
      milestoneForm.value.topicId = ''
      
      // 刷新主题列表
      await loadAvailableTopics()
    } else {
      alert('删除失败：' + (response.message || '未知错误'))
    }
  } catch (error) {
    console.error('删除主题失败:', error)
    alert('删除失败，请稍后重试')
  }
}
```

## 后端实现

### 文件修改

#### 1. Controller层
- `backed/src/main/java/com/knowledge/controller/TimelineEventController.java`
- 新增 `deleteTopic` 方法

```java
/**
 * 删除主题（级联删除该主题下的所有里程碑）
 */
@DeleteMapping("/topic/{topicId}")
public Map<String, Object> deleteTopic(@PathVariable String topicId) {
    Map<String, Object> response = new HashMap<>();
    try {
        // 从session或token获取当前用户，这里暂时使用admin
        int deletedCount = timelineEventService.deleteTopicWithMilestones(topicId, "admin");
        response.put("code", 200);
        response.put("message", "删除成功");
        response.put("data", deletedCount);
    } catch (Exception e) {
        response.put("code", 500);
        response.put("message", "删除失败：" + e.getMessage());
    }
    return response;
}
```

#### 2. Service层
- `backed/src/main/java/com/knowledge/service/TimelineEventService.java`
- 新增 `deleteTopicWithMilestones` 方法

```java
/**
 * 删除主题及其所有里程碑（级联删除）
 */
public int deleteTopicWithMilestones(String topicId, String revisor) {
    return timelineEventMapper.deleteByTopicId(topicId, revisor);
}
```

#### 3. Mapper层
- `backed/src/main/java/com/knowledge/mapper/TimelineEventMapper.java`
- 新增 `deleteByTopicId` 方法

```java
/**
 * 根据主题ID删除所有里程碑（级联删除）
 */
int deleteByTopicId(@Param("topicId") String topicId, @Param("revisor") String revisor);
```

#### 4. XML配置
- `backed/src/main/resources/mapper/TimelineEventMapper.xml`
- 新增 SQL 语句

```xml
<!-- 根据主题ID删除所有里程碑（级联逻辑删除） -->
<update id="deleteByTopicId">
    UPDATE km_timeline_event
    SET arch_flag = '0',
        rec_revisor = #{revisor},
        rec_revise_time = NOW()
    WHERE event_type = 'milestone' 
      AND topic_id = #{topicId}
      AND arch_flag = '1'
</update>
```

## API接口

### 删除主题
- **URL**: `DELETE /timeline/topic/{topicId}`
- **参数**: 
  - `topicId` (路径参数): 主题ID
- **返回**:
  ```json
  {
    "code": 200,
    "message": "删除成功",
    "data": 3  // 删除的记录数
  }
  ```

## 部署步骤

### 1. 后端部署
```bash
cd backed
mvn clean compile
mvn package
java -jar target/knowledge-management-system-1.0.0.jar
```

### 2. 前端部署
前端代码已修改，重新启动开发服务器：
```bash
cd fronted
npm run dev
```

## 注意事项

1. **级联删除**：删除主题时会同时删除该主题下的所有里程碑事件，操作不可撤销
2. **逻辑删除**：后端使用逻辑删除（arch_flag = '0'），数据仍保留在数据库中
3. **主题ID生成**：新建主题使用时间戳生成唯一ID：`user-topic-${Date.now()}`
4. **权限控制**：当前使用admin用户，后续需要集成实际的用户认证系统
5. **数据同步**：删除主题后会自动刷新"时光轨迹"页面的主题列表

## 测试建议

1. **新建主题测试**：
   - 输入合法主题名称，点击确认
   - 输入空白主题名称，验证错误提示
   - 点击取消按钮，验证输入框关闭

2. **删除主题测试**：
   - 选择有里程碑的主题，验证级联删除
   - 选择无里程碑的主题，验证正常删除
   - 取消删除操作，验证主题保留

3. **数据同步测试**：
   - 删除主题后，检查"时光轨迹"页面是否同步更新
   - 新建主题后，检查下拉列表是否立即显示

## 版本记录

- **版本**: v1.7.0
- **日期**: 2025-10-08
- **变更类型**: 功能新增

