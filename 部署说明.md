# 个人知识管理系统 - 宝塔面板部署指南

## 📋 服务器环境要求

- 操作系统：Linux (Debian/Ubuntu/CentOS)
- JDK：1.8+
- MySQL：5.7+
- Nginx：1.26+
- 宝塔面板：已安装

## 🚀 部署步骤

### 第一步：安装必要软件（在宝塔面板）

1. **安装 OpenJDK 1.8**

   - 软件商店 → 搜索 "OpenJDK" → 安装 "OpenJDK 1.8"
2. **已安装的软件**（你已经安装好了）

   - ✓ MySQL 5.7.44
   - ✓ Nginx 1.26.3
   - ✓ phpMyAdmin 4.4

### 第二步：创建目录结构（SSH终端）

```bash
# 创建前端目录（如果添加网站时没有自动创建）
mkdir -p /www/wwwroot/www.personalmanange.xyz

# 创建后端目录
mkdir -p /www/wwwroot/knowledge-backend/logs

# 设置权限
chmod -R 755 /www/wwwroot/www.personalmanange.xyz
chmod -R 755 /www/wwwroot/knowledge-backend
```

### 第三步：配置数据库

1. **数据库信息**（你已创建）

   - 数据库名：`knowledge_management` ✓
   - 用户名：`knowledge_management` ✓
   - 密码：记得你设置的密码
2. **导入数据库结构**

   - 进入宝塔面板 → 数据库 → 点击 `knowledge_management` 的"管理"
   - 进入 phpMyAdmin
   - 点击"SQL"标签
   - 依次执行项目中的SQL文件：
     - `backed/src/main/resources/db/schema.sql` （主表结构）
     - `backed/src/main/resources/db/user-schema.sql` （用户表）
     - `backed/src/main/resources/db/data.sql` （测试数据，可选）

### 第四步：修改配置文件

1. **修改生产环境配置**

   - 编辑 `backed/src/main/resources/application-prod.properties`
   - 修改第23行的数据库密码：
     ```properties
     spring.datasource.password=你在宝塔设置的数据库密码
     ```
2. **修改前端配置**

   - 编辑 `fronted/.env.production`
   - 修改第3行的服务器地址：
     ```
     VITE_API_BASE_URL=http://你的服务器IP/api
     ```
   - 如果有域名，可以改成：
     ```
     VITE_API_BASE_URL=http://你的域名/api
     ```

### 第五步：本地打包项目

**打包后端：**

```bash
# 进入后端目录
cd backed

# Maven打包（跳过测试）
mvn clean package -DskipTests

# 打包成功后，jar包位置：backed/target/knowledge-management-system-1.0.0.jar
```

**打包前端：**

```bash
# 进入前端目录
cd fronted

# 安装依赖（如果还没安装）
npm install

# 打包
npm run build

# 打包成功后，文件位置：fronted/dist/
```

### 第六步：上传文件到服务器

**方式1：使用宝塔文件管理器**

1. 登录宝塔面板
2. 点击"文件"
3. 上传文件：
   - 后端：将 `backed/target/knowledge-management-system-1.0.0.jar` 上传到 `/www/wwwroot/knowledge-backend/`
   - 前端：将 `fronted/dist/` 中的所有文件上传到 `/www/wwwroot/www.personalmanange.xyz/`
   - 脚本：将 `deploy/` 中的 `.sh` 文件上传到 `/www/wwwroot/knowledge-backend/`

**方式2：使用FTP**

- 使用宝塔的FTP功能或任意FTP客户端
- 连接信息在宝塔面板的FTP管理中查看

### 第七步：配置 Nginx

1. **添加网站**

   - 宝塔面板 → 网站 → 添加站点
   - 域名：`www.personalmanange.xyz`
   - 根目录：`/www/wwwroot/www.personalmanange.xyz`
   - PHP版本：纯静态
   - 数据库：不创建
2. **修改Nginx配置**

   - 点击网站后面的"设置"
   - 点击"配置文件"
   - 参考 `deploy/nginx.conf` 文件内容修改配置
   - 主要添加这段到 `server` 块中：

   ```nginx
   location /api/ {
       proxy_pass http://localhost:8080/api/;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
   }

   location / {
       try_files $uri $uri/ /index.html;
   }
   ```

   - 保存并重载Nginx

### 第八步：启动后端服务

**SSH终端操作：**

```bash
# 进入应用目录
cd /www/wwwroot/knowledge-backend

# 赋予脚本执行权限
chmod +x start.sh stop.sh restart.sh

# 启动应用
./start.sh

# 查看日志（检查是否启动成功）
tail -f logs/application.log
# 按 Ctrl+C 退出日志查看
```

### 第九步：测试访问

1. **访问前端页面**

   - 打开浏览器访问：`http://www.personalmanange.xyz` 或 `http://38.246.252.250`
2. **测试登录**

   - 默认账号：`admin`
   - 默认密码：`12345`
3. **检查控制台**

   - 按F12打开浏览器开发者工具
   - 查看Network标签，检查API请求是否正常

## 🔧 常用命令

```bash
# 启动服务
./start.sh

# 停止服务
./stop.sh

# 重启服务
./restart.sh

# 查看日志
tail -f logs/application.log

# 查看进程
ps -ef | grep knowledge-management

# 查看端口占用
netstat -anp | grep 8080
```

## 📁 目录结构

```
/www/wwwroot/
├── www.personalmanange.xyz/        # 前端目录（网站根目录）
│   ├── index.html                 # 入口文件
│   └── assets/                    # 静态资源
│       ├── *.js
│       ├── *.css
│       └── ...
│
└── knowledge-backend/              # 后端目录（独立目录）
    ├── knowledge-management-system-1.0.0.jar  # 应用jar包
    ├── start.sh                   # 启动脚本
    ├── stop.sh                    # 停止脚本
    ├── restart.sh                 # 重启脚本
    ├── app.pid                    # 进程ID文件（运行时生成）
    └── logs/                      # 日志目录
        ├── application.log        # 应用日志
        └── app.log               # 控制台输出
```

## ⚠️ 注意事项

1. **防火墙设置**

   - 确保服务器安全组/防火墙开放了以下端口：
     - 80 (HTTP)
     - 443 (HTTPS，如果配置了SSL)
     - 8080 (后端API，仅本地访问)
2. **数据库配置**

   - 确保数据库密码正确
   - 确保数据库用户有足够权限
3. **日志查看**

   - 如果启动失败，查看日志文件排查问题
   - 应用日志：`/www/wwwroot/knowledge-backend/logs/application.log`
   - 控制台输出：`/www/wwwroot/knowledge-backend/logs/app.log`
4. **跨域问题**

   - 通过Nginx代理后端API，前后端使用同一域名，不会有跨域问题
5. **更新部署**

   - 重新打包后，先停止服务
   - 上传新的jar包覆盖旧文件
   - 重新启动服务

## 🔄 设置开机自启（可选）

**方式1：使用Supervisor（推荐）**

1. 宝塔软件商店搜索 "Supervisor" → 安装
2. 添加守护进程：
   - 名称：`knowledge-management`
   - 运行目录：`/www/wwwroot/knowledge-backend`
   - 启动命令：`java -jar knowledge-management-system-1.0.0.jar --spring.profiles.active=prod`
   - 进程数量：1

**方式2：使用系统服务**

```bash
# 创建systemd服务文件
sudo nano /etc/systemd/system/knowledge-management.service

# 添加内容：
[Unit]
Description=Knowledge Management System
After=network.target

[Service]
Type=simple
User=www
WorkingDirectory=/www/wwwroot/knowledge-backend
ExecStart=/usr/bin/java -jar knowledge-management-system-1.0.0.jar --spring.profiles.active=prod
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target

# 启用服务
sudo systemctl enable knowledge-management
sudo systemctl start knowledge-management
```

## 🐛 常见问题

**1. 端口8080被占用**

```bash
# 查找占用进程
lsof -i:8080
# 或
netstat -anp | grep 8080

# 杀死进程
kill -9 进程ID
```

**2. 数据库连接失败**

- 检查数据库是否启动
- 检查用户名、密码是否正确
- 检查数据库权限

**3. 前端访问404**

- 检查Nginx配置中的 `try_files $uri $uri/ /index.html;`
- 检查前端文件是否正确上传

**4. API请求失败**

- 检查后端服务是否启动：`ps -ef | grep java`
- 检查8080端口是否监听：`netstat -anp | grep 8080`
- 检查Nginx代理配置是否正确

## 📞 技术支持

如遇到问题：

1. 查看应用日志
2. 查看Nginx错误日志：`/www/wwwlogs/knowledge-management_error.log`
3. 检查服务器资源：`top` 或 `htop`

---

祝部署顺利！🎉
