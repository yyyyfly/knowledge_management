<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.knowledge.mapper.NoteMapper">
    
    <resultMap id="BaseResultMap" type="com.knowledge.entity.Note">
        <id column="id" property="id"/>
        <result column="type" property="type"/>
        <result column="title" property="title"/>
        <result column="summary" property="summary"/>
        <result column="content" property="content"/>
        <result column="tags" property="tags"/>
        <!-- 框架笔记字段 -->
        <result column="subject_type" property="subjectType"/>
        <result column="knowledge_point" property="knowledgePoint"/>
        <!-- 求学笔记字段 -->
        <result column="study_subject" property="studySubject"/>
        <result column="core_concept" property="coreConcept"/>
        <result column="mechanism" property="mechanism"/>
        <result column="application_case" property="applicationCase"/>
        <result column="extension" property="extension"/>
        <result column="common_mistake" property="commonMistake"/>
        <result column="reflection" property="reflection"/>
        <!-- 背诵笔记字段 -->
        <result column="project" property="project"/>
        <result column="original_text" property="originalText"/>
        <result column="explanation" property="explanation"/>
        <result column="cue" property="cue"/>
        <!-- 刷题笔记字段 -->
        <result column="exercise_source" property="exerciseSource"/>
        <result column="exercise_subject" property="exerciseSubject"/>
        <result column="exercise_knowledge" property="exerciseKnowledge"/>
        <result column="exercise_difficulty" property="exerciseDifficulty"/>
        <result column="question_description" property="questionDescription"/>
        <result column="analysis" property="analysis"/>
        <result column="reference_answer" property="referenceAnswer"/>
        <!-- 实战笔记字段 -->
        <result column="tech_tags" property="techTags"/>
        <result column="project_type" property="projectType"/>
        <result column="requirement_description" property="requirementDescription"/>
        <result column="design_thinking" property="designThinking"/>
        <result column="reference_design" property="referenceDesign"/>
        <!-- 碎片笔记字段 -->
        <result column="fragment_category" property="fragmentCategory"/>
        <result column="fragment_theme" property="fragmentTheme"/>
        <result column="importance" property="importance"/>
        <!-- 巩固复习字段 -->
        <result column="review_count" property="reviewCount"/>
        <result column="last_review_time" property="lastReviewTime"/>
        <!-- 标准字段 -->
        <result column="rec_creator" property="recCreator"/>
        <result column="rec_create_time" property="recCreateTime"/>
        <result column="rec_revisor" property="recRevisor"/>
        <result column="rec_revise_time" property="recReviseTime"/>
        <result column="arch_flag" property="archFlag"/>
    </resultMap>
    
    <sql id="Base_Column_List">
        id, type, title, summary, content, tags,
        subject_type, knowledge_point, 
        study_subject, core_concept, mechanism, application_case, extension, common_mistake, reflection,
        project, original_text, explanation, cue,
        exercise_source, exercise_subject, exercise_knowledge, exercise_difficulty,
        question_description, analysis, reference_answer,
        tech_tags, project_type, requirement_description, design_thinking, reference_design,
        fragment_category, fragment_theme, importance,
        review_count, last_review_time,
        rec_creator, rec_create_time, rec_revisor, rec_revise_time, arch_flag
    </sql>
    
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM km_note
        WHERE id = #{id} AND arch_flag = 0 AND rec_creator = #{recCreator}
    </select>
    
    <select id="selectAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM km_note
        WHERE arch_flag = 0 AND rec_creator = #{recCreator}
        ORDER BY rec_create_time DESC
    </select>
    
    <select id="selectByType" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM km_note
        WHERE type = #{type} AND arch_flag = 0 AND rec_creator = #{recCreator}
        ORDER BY rec_create_time DESC
    </select>
    
    <select id="search" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM km_note
        WHERE (title LIKE CONCAT('%', #{keyword}, '%') OR summary LIKE CONCAT('%', #{keyword}, '%'))
        AND arch_flag = 0 AND rec_creator = #{recCreator}
        ORDER BY rec_create_time DESC
    </select>
    
    <select id="selectByTypeRecommended" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM km_note
        WHERE type = #{type} AND arch_flag = 0 AND rec_creator = #{recCreator}
        ORDER BY 
            CASE WHEN review_count = 0 OR last_review_time IS NULL THEN 0 ELSE 1 END,
            last_review_time ASC,
            rec_create_time DESC
        LIMIT 5
    </select>
    
    <insert id="insert" parameterType="com.knowledge.entity.Note" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO km_note (
            type, title, summary, content, tags,
            subject_type, knowledge_point, 
            study_subject, core_concept, mechanism, application_case, extension, common_mistake, reflection,
            project, original_text, explanation, cue,
            exercise_source, exercise_subject, exercise_knowledge, exercise_difficulty,
            question_description, analysis, reference_answer,
            tech_tags, project_type, requirement_description, design_thinking, reference_design,
            fragment_category, fragment_theme, importance,
            rec_creator, rec_create_time, arch_flag
        ) VALUES (
            #{type}, #{title}, #{summary}, #{content}, #{tags},
            #{subjectType}, #{knowledgePoint}, 
            #{studySubject}, #{coreConcept}, #{mechanism}, #{applicationCase}, #{extension}, #{commonMistake}, #{reflection},
            #{project}, #{originalText}, #{explanation}, #{cue},
            #{exerciseSource}, #{exerciseSubject}, #{exerciseKnowledge}, #{exerciseDifficulty},
            #{questionDescription}, #{analysis}, #{referenceAnswer},
            #{techTags}, #{projectType}, #{requirementDescription}, #{designThinking}, #{referenceDesign},
            #{fragmentCategory}, #{fragmentTheme}, #{importance},
            #{recCreator}, NOW(), 0
        )
    </insert>
    
    <update id="update" parameterType="com.knowledge.entity.Note">
        UPDATE km_note
        <set>
            <if test="type != null and type != ''">type = #{type},</if>
            <if test="title != null and title != ''">title = #{title},</if>
            <if test="summary != null and summary != ''">summary = #{summary},</if>
            <if test="content != null and content != ''">content = #{content},</if>
            <if test="tags != null and tags != ''">tags = #{tags},</if>
            <!-- 框架笔记字段 -->
            <if test="subjectType != null and subjectType != ''">subject_type = #{subjectType},</if>
            <if test="knowledgePoint != null and knowledgePoint != ''">knowledge_point = #{knowledgePoint},</if>
            <!-- 求学笔记字段 -->
            <if test="studySubject != null and studySubject != ''">study_subject = #{studySubject},</if>
            <if test="coreConcept != null and coreConcept != ''">core_concept = #{coreConcept},</if>
            <if test="mechanism != null and mechanism != ''">mechanism = #{mechanism},</if>
            <if test="applicationCase != null and applicationCase != ''">application_case = #{applicationCase},</if>
            <if test="extension != null and extension != ''">extension = #{extension},</if>
            <if test="commonMistake != null and commonMistake != ''">common_mistake = #{commonMistake},</if>
            <if test="reflection != null and reflection != ''">reflection = #{reflection},</if>
            <!-- 背诵笔记字段 -->
            <if test="project != null and project != ''">project = #{project},</if>
            <if test="originalText != null and originalText != ''">original_text = #{originalText},</if>
            <if test="explanation != null and explanation != ''">explanation = #{explanation},</if>
            <if test="cue != null and cue != ''">cue = #{cue},</if>
            <!-- 刷题笔记字段 -->
            <if test="exerciseSource != null and exerciseSource != ''">exercise_source = #{exerciseSource},</if>
            <if test="exerciseSubject != null and exerciseSubject != ''">exercise_subject = #{exerciseSubject},</if>
            <if test="exerciseKnowledge != null and exerciseKnowledge != ''">exercise_knowledge = #{exerciseKnowledge},</if>
            <if test="exerciseDifficulty != null and exerciseDifficulty != ''">exercise_difficulty = #{exerciseDifficulty},</if>
            <if test="questionDescription != null and questionDescription != ''">question_description = #{questionDescription},</if>
            <if test="analysis != null and analysis != ''">analysis = #{analysis},</if>
            <if test="referenceAnswer != null and referenceAnswer != ''">reference_answer = #{referenceAnswer},</if>
            <!-- 实战笔记字段 -->
            <if test="techTags != null and techTags != ''">tech_tags = #{techTags},</if>
            <if test="projectType != null and projectType != ''">project_type = #{projectType},</if>
            <if test="requirementDescription != null and requirementDescription != ''">requirement_description = #{requirementDescription},</if>
            <if test="designThinking != null and designThinking != ''">design_thinking = #{designThinking},</if>
            <if test="referenceDesign != null and referenceDesign != ''">reference_design = #{referenceDesign},</if>
            <!-- 碎片笔记字段 -->
            <if test="fragmentCategory != null and fragmentCategory != ''">fragment_category = #{fragmentCategory},</if>
            <if test="fragmentTheme != null and fragmentTheme != ''">fragment_theme = #{fragmentTheme},</if>
            <if test="importance != null and importance != ''">importance = #{importance},</if>
            <!-- 标准字段 -->
            <if test="recRevisor != null">rec_revisor = #{recRevisor},</if>
            rec_revise_time = NOW()
        </set>
        WHERE id = #{id}
    </update>
    
    <update id="updateReviewInfo">
        UPDATE km_note
        SET review_count = #{reviewCount},
            last_review_time = #{lastReviewTime},
            rec_revise_time = NOW()
        WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        UPDATE km_note
        SET arch_flag = 1, rec_revise_time = NOW()
        WHERE id = #{id}
    </delete>
    
</mapper>

