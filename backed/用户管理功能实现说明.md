# 用户管理功能实现说明

## 📋 **功能概述**

新增了用户管理功能，允许管理员（admin用户）查看系统中所有用户的信息，同时在注册时增加了用户名重复检测功能。

## ✅ **实现功能**

### 1. 用户管理页面（仅管理员可访问）
- ✅ 显示所有用户列表
- ✅ 查看用户详细信息（用户名、昵称、邮箱、手机号、状态、最后登录时间、注册时间）
- ✅ 统计总用户数和活跃用户数
- ✅ 权限控制：只有admin用户可以访问

### 2. 用户名重复检测
- ✅ 注册时自动检查用户名是否已存在
- ✅ 提供公开API供前端实时检查用户名可用性

### 3. 权限控制
- ✅ 路由级别权限检查（requiresAdmin）
- ✅ API级别权限检查（验证admin用户）
- ✅ UI级别权限控制（侧边栏菜单仅admin可见）

## 🔧 **后端实现**

### 1. 数据库（已存在）
**表名**：`sys_user`

主要字段：
- `id` - 用户ID
- `username` - 用户名（唯一索引）
- `password` - 密码（MD5加密）
- `nickname` - 昵称
- `email` - 邮箱
- `phone` - 手机号
- `status` - 状态（1-正常，0-禁用）
- `last_login_time` - 最后登录时间
- `rec_create_time` - 注册时间

### 2. Mapper层

**文件**：`backed/src/main/java/com/knowledge/mapper/UserMapper.java`

新增方法：
```java
// 查询所有用户（仅管理员可用）
java.util.List<User> findAllUsers();

// 检查用户名是否已存在
int countByUsername(@Param("username") String username);
```

**文件**：`backed/src/main/resources/mapper/UserMapper.xml`

新增SQL：
```xml
<!-- 查询所有用户（不返回密码） -->
<select id="findAllUsers" resultMap="BaseResultMap">
    SELECT 
        id, username, nickname, email, phone, avatar, status,
        last_login_time, rec_creator, rec_create_time,
        rec_revisor, rec_revise_time, arch_flag
    FROM sys_user
    WHERE arch_flag = 0
    ORDER BY rec_create_time DESC
</select>

<!-- 检查用户名是否已存在 -->
<select id="countByUsername" resultType="int">
    SELECT COUNT(*)
    FROM sys_user
    WHERE username = #{username}
    AND arch_flag = 0
</select>
```

### 3. Service层

**文件**：`backed/src/main/java/com/knowledge/service/AuthService.java`

新增接口方法：
```java
// 获取所有用户列表（仅管理员）
java.util.List<User> getAllUsers();

// 检查用户名是否已存在
boolean isUsernameExists(String username);
```

**文件**：`backed/src/main/java/com/knowledge/service/impl/AuthServiceImpl.java`

实现方法：
```java
@Override
public java.util.List<User> getAllUsers() {
    java.util.List<User> users = userMapper.findAllUsers();
    // 清除所有用户的密码信息
    for (User user : users) {
        user.setPassword(null);
    }
    return users;
}

@Override
public boolean isUsernameExists(String username) {
    int count = userMapper.countByUsername(username);
    return count > 0;
}
```

### 4. Controller层

**文件**：`backed/src/main/java/com/knowledge/controller/AuthController.java`

新增API接口：

#### 获取所有用户列表（仅管理员）
```java
@GetMapping("/users")
public Result<java.util.List<User>> getAllUsers(@RequestHeader("Authorization") String token)
```
- **请求方式**：GET
- **接口路径**：`/auth/users`
- **权限要求**：admin用户
- **返回数据**：用户列表（不含密码）

#### 检查用户名是否存在（公开接口）
```java
@GetMapping("/check-username")
public Result<Boolean> checkUsername(@RequestParam("username") String username)
```
- **请求方式**：GET
- **接口路径**：`/auth/check-username?username={用户名}`
- **权限要求**：无（公开）
- **返回数据**：boolean（true-已存在，false-可用）

### 5. 权限检查逻辑

在 `getAllUsers` 方法中：
```java
String username = JwtUtil.getUsernameFromToken(token);

// 权限检查：只有admin用户可以访问
if (!"admin".equals(username)) {
    return Result.error("权限不足，只有管理员可以访问");
}
```

## 💻 **前端实现**

### 1. 用户管理页面

**文件**：`fronted/src/views/system/UserManagement.vue`

**功能特点**：
- 📊 **统计卡片**：显示总用户数和活跃用户数
- 🔐 **权限提示**：显眼的管理员专属标识
- 📋 **用户表格**：展示所有用户信息
- 🎨 **美观设计**：渐变背景、悬停效果、状态标签
- 👤 **用户头像**：自动生成的首字母头像
- 👑 **管理员标识**：admin用户显示王冠图标

**表格列**：
1. ID
2. 用户名（带头像和管理员标识）
3. 昵称
4. 邮箱
5. 手机号
6. 状态（正常/禁用，带状态指示灯）
7. 最后登录时间
8. 注册时间

### 2. 路由配置

**文件**：`fronted/src/router/index.ts`

新增路由：
```typescript
{
  path: '/user-management',
  name: 'user-management',
  component: () => import('@/views/system/UserManagement.vue'),
  meta: { requiresAuth: true, requiresAdmin: true }
}
```

### 3. 路由守卫增强

在 `router.beforeEach` 中添加admin权限检查：
```typescript
// 检查是否需要管理员权限
if (to.meta.requiresAdmin) {
  const userStr = localStorage.getItem('user')
  if (userStr) {
    try {
      const user = JSON.parse(userStr)
      if (user.username === 'admin') {
        next()
      } else {
        alert('权限不足，该页面仅管理员可访问')
        next('/')
      }
    } catch (e) {
      next('/')
    }
  } else {
    next('/')
  }
}
```

### 4. 侧边栏菜单

**文件**：`fronted/src/components/Sidebar.vue`

新增菜单项（仅admin可见）：
```vue
<router-link v-if="isAdmin" to="/user-management" class="...">
  <div class="w-6 flex justify-center">
    <i class="fa-solid fa-users-cog"></i>
  </div>
  <span class="ml-3 flex items-center">
    用户管理
    <span class="ml-2 px-2 py-0.5 rounded text-xs bg-red-500/20 text-red-400 border border-red-500/30">
      <i class="fas fa-crown mr-1"></i>Admin
    </span>
  </span>
</router-link>
```

添加admin判断逻辑：
```typescript
const isAdmin = computed(() => {
  const userStr = localStorage.getItem('user')
  if (userStr) {
    try {
      const user = JSON.parse(userStr)
      return user.username === 'admin'
    } catch {
      return false
    }
  }
  return false
})
```

## 🔒 **三层权限控制**

### 1. 路由层（第一道防线）
- 在 `router/index.ts` 的路由守卫中检查
- 非admin用户访问会被重定向到首页并提示

### 2. API层（第二道防线）
- 在后端Controller中验证用户身份
- 非admin用户请求会返回错误信息

### 3. UI层（第三道防线）
- 侧边栏菜单根据用户身份动态显示
- 非admin用户根本看不到"用户管理"入口

## 🚀 **使用说明**

### 管理员访问用户管理页面

1. **使用admin账号登录**
   - 用户名：`admin`
   - 密码：`12345`

2. **打开侧边栏**
   - 展开"系统配置"分组

3. **点击"用户管理"菜单**
   - 会看到带有"👑 Admin"标识的菜单项

4. **查看用户列表**
   - 页面显示所有注册用户的信息
   - 顶部显示用户统计数据

### 普通用户

- 侧边栏**不会显示**"用户管理"菜单项
- 即使通过URL直接访问 `/user-management`，也会被拦截并提示权限不足

### 注册新用户时的用户名检测

注册接口中已有用户名检测逻辑：
```java
// 检查用户名是否已存在
User existingUser = userMapper.findByUsername(username);
if (existingUser != null) {
    throw new RuntimeException("用户名已存在");
}
```

如需前端实时检测，可调用：
```javascript
const response = await request.get('/auth/check-username', {
  params: { username: 'testuser' }
})
// response.data 为 true（已存在）或 false（可用）
```

## 📊 **API接口汇总**

| 接口 | 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|------|
| 获取用户列表 | GET | `/auth/users` | admin | 返回所有用户信息（不含密码） |
| 检查用户名 | GET | `/auth/check-username?username={name}` | 公开 | 返回用户名是否已存在 |

## 🎨 **页面效果**

### 统计卡片
```
┌─────────────────────────────┐
│  总用户数    |    活跃用户   │
│     5       |       4       │
└─────────────────────────────┘
```

### 用户列表
```
┌─────┬──────────────┬────────┬────────────┬──────────┬────────┬──────────────┬──────────────┐
│ ID  │   用户名      │  昵称  │   邮箱     │  手机号  │  状态  │ 最后登录     │  注册时间    │
├─────┼──────────────┼────────┼────────────┼──────────┼────────┼──────────────┼──────────────┤
│  1  │ [A] admin 👑 │ Admin  │ admin@... │  -       │ ● 正常 │ 2025-10-08  │ 2025-10-07  │
│  2  │ [T] testuser │ 测试   │ test@...  │ 13900... │ ● 正常 │ 2025-10-08  │ 2025-10-08  │
└─────┴──────────────┴────────┴────────────┴──────────┴────────┴──────────────┴──────────────┘
```

## 🔍 **测试建议**

### 1. admin用户测试
- ✅ 登录admin账号
- ✅ 查看侧边栏是否显示"用户管理"菜单
- ✅ 点击进入用户管理页面
- ✅ 查看用户列表是否正常显示
- ✅ 查看统计数据是否正确

### 2. 普通用户测试
- ✅ 登录普通账号
- ✅ 确认侧边栏不显示"用户管理"菜单
- ✅ 尝试直接访问 `/user-management`
- ✅ 应被拦截并重定向到首页

### 3. 注册测试
- ✅ 注册一个新用户
- ✅ 尝试注册相同用户名
- ✅ 应提示"用户名已存在"

## 📅 **版本信息**

- **功能版本**：v1.7.0
- **实现日期**：2025-10-08
- **涉及文件**：
  - 后端：6个文件（Mapper、Service、Controller）
  - 前端：3个文件（页面、路由、侧边栏）

## 💡 **未来扩展建议**

1. **用户管理功能增强**
   - 禁用/启用用户
   - 重置用户密码
   - 删除用户
   - 编辑用户信息

2. **角色管理**
   - 创建不同角色（管理员、普通用户、访客等）
   - 角色权限配置
   - 用户角色分配

3. **用户搜索和过滤**
   - 按用户名搜索
   - 按状态筛选
   - 按注册时间排序

4. **分页功能**
   - 当用户数量较多时实现分页

5. **操作日志**
   - 记录管理员对用户的操作
   - 查看操作历史

---

**总结**：已完整实现用户管理功能，包含三层权限控制，确保只有管理员可以访问用户信息。同时在注册时自动检测用户名重复，提升用户体验和系统安全性。

