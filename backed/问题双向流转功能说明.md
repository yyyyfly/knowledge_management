# 问题双向流转功能说明

## 📝 功能概述

实现了问题在"执行端"和"决策端"之间的双向流转机制，让问题处理更加灵活：

### 执行端 → 决策端
- 在项目记录页面发现问题并记录
- 问题自动流转到系统决策页面等待处理

### 决策端 → 执行端
- 在系统决策页面制定解决方案
- 解决方案自动同步到项目记录页面

### 双向退回机制
- **决策端取消解决**：已解决的问题可以重新开启，重新制定方案
- **执行端退回**：发现解决方案不合适，可以退回重新处理

## 🎯 业务流程

### 完整流程图

```
项目执行 → 发现问题 → 记录问题（ProjectRecord）
                              ↓
                        问题列表展示
                              ↓
                    系统决策（SystemDecisions）
                              ↓
                        制定解决方案
                              ↓
                        标记为已解决
                              ↓
                    解决方案同步到执行端
                              ↓
                        执行端查看方案
                              ↓
                    ┌─────────┴─────────┐
                    │                   │
                 方案合适            方案不合适
                    │                   │
                问题关闭            点击"退回"
                                       ↓
                                 恢复待处理状态
                                       ↓
                                 重新制定方案
```

### 状态流转

```
open（待处理）
    ↓ 决策端点击"标记处理中"
in_progress（处理中）
    ↓ 决策端提交解决方案
resolved（已解决）
    ↓ 决策端"取消解决" 或 执行端"退回"
open（待处理）← 重新开始
```

## 🔧 技术实现

### 前端实现

#### 1. 执行端（ProjectRecord.vue）

**问题显示**：
- ✅ 显示问题的解决方案（如果有）
- ✅ 显示解决时间
- ✅ 已解决问题显示"退回"按钮

**退回功能**：
```javascript
// 退回问题（从执行端退回给决策端）
const reopenIssueFromExecution = async (id: number) => {
  if (!confirm('发现处理方案不合适？确定要退回重新处理吗？')) return
  
  const response = await request.put(`/project/issue/${id}/reopen`)
  if (response.code === 200) {
    alert('✅ 问题已退回，可以重新制定解决方案了')
    await loadIssues()
  }
}
```

**UI改进**：
- 已解决问题：绿色背景高亮
- 退回按钮：黄色背景，带撤销图标
- 解决方案：绿色边框卡片展示

#### 2. 决策端（SystemDecisions.vue）

**取消解决功能**：
```javascript
// 重新开启问题（取消解决）
const reopenIssue = async (id: number) => {
  if (!confirm('确定要取消解决此问题，重新处理吗？')) return
  
  const response = await request.put(`/project/issue/${id}/reopen`)
  if (response.code === 200) {
    alert('✅ 问题已重新开启，可以重新处理了')
    await loadDecisionIssues()
  }
}
```

**UI改进**：
- 未解决问题：显示"制定决策"按钮
- 已解决问题：显示"取消解决，重新处理"按钮（黄色）
- 解决方案：绿色背景展示，包含解决时间

### 后端实现

#### 1. Controller层
**新增接口**：`PUT /project/issue/{id}/reopen`

```java
@PutMapping("/{id}/reopen")
public Result<Void> reopenIssue(@PathVariable Long id, @RequestHeader("Authorization") String token) {
    String username = JwtUtil.getUsernameFromToken(token);
    projectIssueService.reopenIssue(id, username);
    return Result.success(null);
}
```

#### 2. Service层
```java
public void reopenIssue(Long id, String revisor) {
    projectIssueMapper.reopenIssue(id, revisor);
}
```

#### 3. Mapper层
```java
int reopenIssue(@Param("id") Long id, @Param("revisor") String revisor);
```

#### 4. SQL实现
```xml
<update id="reopenIssue">
    UPDATE km_project_issue
    SET status = 'open',
        solution = NULL,
        resolve_time = NULL,
        rec_revisor = #{revisor},
        rec_revise_time = NOW()
    WHERE id = #{id}
</update>
```

## ✨ 核心特性

### 1. 双向互通
- 执行端记录的问题，决策端立即可见
- 决策端的解决方案，执行端实时同步

### 2. 状态管理
- **待处理（open）**：问题刚记录或被退回
- **处理中（in_progress）**：决策端正在处理
- **已解决（resolved）**：已有解决方案

### 3. 灵活退回
- **决策端取消**：发现方案有误，主动取消重做
- **执行端退回**：实施中发现不可行，退回重新决策

### 4. 数据清理
退回时自动清理：
- ✅ 解决方案（solution）置为 NULL
- ✅ 解决时间（resolve_time）置为 NULL
- ✅ 状态（status）改为 'open'

## 🎨 用户体验

### 执行端体验
1. **问题记录**：在项目执行页面发现问题，点击"问题管理" → "记录问题"
2. **等待决策**：问题提交后，等待决策端处理
3. **查看方案**：决策完成后，可以看到绿色高亮的解决方案
4. **反馈意见**：
   - 方案合适 → 关闭问题
   - 方案不合适 → 点击"退回"按钮，重新处理

### 决策端体验
1. **接收问题**：在系统决策页面看到所有待处理问题
2. **制定方案**：点击"制定决策"，填写解决方案
3. **标记解决**：提交后问题变为已解决状态
4. **灵活调整**：
   - 发现方案有误 → 点击"取消解决，重新处理"
   - 收到执行端退回 → 重新制定更好的方案

## 📊 数据流转示例

### 场景：处理一个技术问题

1. **执行端记录**：
   ```
   问题标题：登录接口响应超时
   问题描述：用户登录时，接口响应时间超过5秒
   优先级：高
   状态：待处理
   ```

2. **决策端处理**：
   ```
   解决方案：
   1. 优化数据库查询，添加索引
   2. 增加Redis缓存层
   3. 调整Nginx超时配置
   
   状态：已解决
   解决时间：2025-10-09 15:30
   ```

3. **执行端实施**：
   - 查看解决方案
   - 发现Redis方案不可行（环境限制）
   - 点击"退回"

4. **决策端重新处理**：
   ```
   解决方案（修订版）：
   1. 优化数据库查询，添加索引
   2. 使用本地缓存替代Redis
   3. 调整Nginx超时配置
   
   状态：已解决（再次）
   ```

5. **最终完成**：执行端确认方案可行，问题关闭

## 🚀 部署说明

### 前端
无需特殊配置，已集成到现有页面：
- `/daily/project-record` - 项目记录（执行端）
- `/system-decisions` - 系统决策（决策端）

### 后端
1. 确保已部署最新的 `ProjectIssueController`
2. 确保已部署最新的 `ProjectIssueMapper.xml`
3. 数据库无需修改（使用现有字段）

### API接口
新增接口：
- `PUT /project/issue/{id}/reopen` - 重新开启问题

## ✅ 功能验证

### 测试流程
1. ✅ 在执行端记录一个问题
2. ✅ 在决策端查看并制定解决方案
3. ✅ 返回执行端，确认能看到解决方案
4. ✅ 点击"退回"按钮，问题恢复待处理
5. ✅ 返回决策端，确认问题已重新开启
6. ✅ 在决策端重新处理并解决
7. ✅ 在决策端点击"取消解决"，验证问题恢复待处理

## 💡 设计亮点

1. **闭环管理**：从发现问题到解决问题，再到反馈调整，形成完整闭环
2. **角色分离**：执行端专注执行，决策端专注决策，职责清晰
3. **灵活可退**：任何环节发现不对都能退回，避免错误决策
4. **状态清晰**：通过颜色和图标明确区分不同状态
5. **用户友好**：所有操作都有确认提示和成功反馈

---

*功能实现时间：2025-10-09*  
*适用版本：v1.9.0+*


